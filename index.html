<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Multi-Game Party</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif; margin: 0; background: #111; color: white; overflow: hidden; touch-action: none; }
        .hidden { display: none !important; }
        .full-screen { position: absolute; top:0; left:0; width: 100vw; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; }

        /* --- UI: å…±é€š --- */
        #room-info { position: absolute; top: 10px; left: 10px; z-index: 100; font-size: 14px; color: #aaa; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 4px; }
        
        /* --- UI: ãƒ›ã‚¹ãƒˆï¼ˆPCï¼‰ --- */
        #host-lobby { background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d); z-index: 10; text-align: center; }
        #game-menu { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px; }
        .game-card { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .game-card:hover { background: rgba(255,255,255,0.3); transform: scale(1.05); border-color: #fff; }
        .game-title { font-weight: bold; font-size: 18px; margin-bottom: 5px; }
        
        #game-container-3d, #game-container-2d { width: 100%; height: 100%; background: #000; }
        
        /* --- UI: ã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ©ãƒ¼ï¼ˆã‚¹ãƒãƒ›ï¼‰ --- */
        #controller-view { background: #222; }
        
        /* ã‚¸ãƒ§ã‚¤ã‚¹ãƒ†ã‚£ãƒƒã‚¯ï¼ˆ3Dç”¨ï¼‰ */
        #joystick-zone { width: 300px; height: 300px; background: rgba(255,255,255,0.1); border-radius: 50%; position: relative; margin-bottom: 20px; border: 2px solid rgba(255,255,255,0.2); }
        #joystick-knob { width: 80px; height: 80px; background: #00d4ff; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 15px #00d4ff; pointer-events: none; }
        
        /* ãƒœã‚¿ãƒ³ãƒ‘ãƒƒãƒ‰ï¼ˆ2Dç”¨ï¼‰ */
        #dpad-zone { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .d-btn { width: 70px; height: 70px; background: #444; border-radius: 10px; border: none; font-size: 24px; color: white; }
        .d-btn:active { background: #666; }
        
        .action-btn { width: 120px; height: 120px; border-radius: 50%; background: #ff4757; color: white; border: none; font-weight: bold; font-size: 20px; margin-top: 20px; box-shadow: 0 5px #c0392b; }
        .action-btn:active { transform: translateY(5px); box-shadow: 0 0px #c0392b; }

        /* ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ãƒªã‚¹ãƒˆ */
        #player-list { margin-top: 20px; font-size: 14px; color: #ddd; }
    </style>
</head>
<body>

    <!-- éƒ¨å±‹IDè¡¨ç¤º -->
    <div id="room-info">Loading...</div>

    <!-- HOST: ãƒ­ãƒ“ãƒ¼ç”»é¢ -->
    <div id="host-lobby" class="full-screen hidden">
        <h1>GAME SELECTOR</h1>
        <div id="qrcode" style="background: white; padding: 10px; border-radius: 8px;"></div>
        <p>ã‚¹ãƒãƒ›ã§ã‚¹ã‚­ãƒ£ãƒ³ã—ã¦å‚åŠ ï¼</p>
        
        <div id="game-menu">
            <div class="game-card" onclick="selectGame('flight3d')">
                <div class="game-title">âœˆï¸ 3D SKY BATTLE</div>
                <div class="desc">3Dç©ºé–“ã‚’è‡ªç”±ã«é£›è¡Œ</div>
            </div>
            <div class="game-card" onclick="selectGame('shooter2d')">
                <div class="game-title">ğŸ”« 2D SHOOTER</div>
                <div class="desc">å…¨æ–¹å‘ã‚·ãƒ¥ãƒ¼ãƒ†ã‚£ãƒ³ã‚°</div>
            </div>
            <div class="game-card" onclick="selectGame('sumo')">
                <div class="game-title">ğŸ¤¼ CIRCLE SUMO</div>
                <div class="desc">ä½“å½“ãŸã‚Šã§è½ã¨ã—åˆã„</div>
            </div>
            <div class="game-card" onclick="selectGame('paint')">
                <div class="game-title">ğŸ¨ PAINT WAR</div>
                <div class="desc">åºŠã‚’è‡ªåˆ†ã®è‰²ã«å¡—ã‚Œ</div>
            </div>
            <div class="game-card" onclick="selectGame('sniper')">
                <div class="game-title">ğŸ¯ GYRO SNIPER</div>
                <div class="desc">ã‚¹ãƒãƒ›ã‚’å‚¾ã‘ã¦ç‹™æ’ƒ</div>
            </div>
            <div class="game-card" onclick="selectGame('race')">
                <div class="game-title">ğŸ TAP RACING</div>
                <div class="desc">é€£æ‰“ã§åŠ é€Ÿãƒ¬ãƒ¼ã‚¹</div>
            </div>
        </div>
        <div id="player-list">å‚åŠ è€…å¾…æ©Ÿä¸­...</div>
    </div>

    <!-- HOST: 3Dã‚²ãƒ¼ãƒ ç”»é¢ -->
    <div id="host-3d" class="full-screen hidden">
        <div id="game-container-3d"></div>
        <button onclick="backToLobby()" style="position: absolute; top:10px; right:10px; z-index: 100;">MENU</button>
    </div>

    <!-- HOST: 2Dã‚²ãƒ¼ãƒ ç”»é¢ -->
    <div id="host-2d" class="full-screen hidden">
        <canvas id="canvas-2d"></canvas>
        <button onclick="backToLobby()" style="position: absolute; top:10px; right:10px; z-index: 100;">MENU</button>
    </div>

    <!-- CONTROLLER: ã‚¹ãƒãƒ›ç”»é¢ -->
    <div id="controller-view" class="full-screen hidden">
        <h2 id="ctrl-title" style="margin-bottom: 20px;">WAITING...</h2>
        
        <!-- UI: Joystick -->
        <div id="ui-joystick" class="hidden">
            <div id="joystick-zone">
                <div id="joystick-knob"></div>
            </div>
            <p>Drag to Fly</p>
            <button class="action-btn" id="btn-boost">BOOST</button>
        </div>

        <!-- UI: D-Pad -->
        <div id="ui-dpad" class="hidden">
            <div id="dpad-zone">
                <div></div><button class="d-btn" id="d-up">â–²</button><div></div>
                <button class="d-btn" id="d-left">â—€</button><div></div><button class="d-btn" id="d-right">â–¶</button>
                <div></div><button class="d-btn" id="d-down">â–¼</button><div></div>
            </div>
            <button class="action-btn" id="btn-fire">FIRE</button>
        </div>

        <!-- UI: Tap/Gyro -->
        <div id="ui-simple" class="hidden">
            <p id="simple-instr">TAP or TILT!</p>
            <button class="action-btn" id="btn-main" style="width: 200px; height: 200px;">ACTION</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        // --- 1. Firebase Setup ---
        const firebaseConfig = {
            apiKey: "AIzaSyDbZzTMvUkG2LXIGY4ux0KBTmnAdqP236s",
            authDomain: "game-4f2d9.firebaseapp.com",
            databaseURL: "https://game-4f2d9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "game-4f2d9",
            storageBucket: "game-4f2d9.firebasestorage.app",
            messagingSenderId: "574316347824",
            appId: "1:574316347824:web:cf686040628e25ad615675",
            measurementId: "G-T0ZKQCC9L3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- 2. Room & Role Logic ---
        const params = new URLSearchParams(window.location.search);
        let role = params.get('role') || 'host';
        let roomId = params.get('room');
        let myId = Math.random().toString(36).substr(2, 6);
        let currentMode = 'lobby';
        
        // Colors for players
        const PLAYER_COLORS = [0xff0000, 0x00ff00, 0x0000ff, 0xffff00, 0xff00ff, 0x00ffff];
        function getColor(id) {
            let hash = 0;
            for(let i=0; i<id.length; i++) hash = id.charCodeAt(i) + ((hash << 5) - hash);
            return PLAYER_COLORS[Math.abs(hash) % PLAYER_COLORS.length];
        }

        // --- HOST LOGIC ---
        if (role === 'host') {
            if (!roomId) {
                roomId = Math.random().toString(36).substring(2, 6).toUpperCase();
                window.location.replace(`?role=host&room=${roomId}`);
            }
            
            document.getElementById('room-info').innerText = `ROOM: ${roomId}`;
            document.getElementById('host-lobby').classList.remove('hidden');

            // Generate QR
            const url = `${window.location.origin}${window.location.pathname}?role=ctrl&room=${roomId}`;
            new QRCode(document.getElementById("qrcode"), { text: url, width: 150, height: 150 });

            // Player Management
            const playersRef = ref(db, `rooms/${roomId}/players`);
            let players = {}; // Local state

            onValue(playersRef, (snap) => {
                players = snap.val() || {};
                updatePlayerList();
            });

            function updatePlayerList() {
                const list = Object.keys(players).map(k => `<span style="color:#${getColor(k).toString(16)}">â— Player ${k.substr(0,3)}</span>`).join(" ");
                document.getElementById('player-list').innerHTML = `å‚åŠ è€…: ${list}`;
            }

            // Game Selection
            window.selectGame = (mode) => {
                currentMode = mode;
                update(ref(db, `rooms/${roomId}`), { mode: mode });
                
                document.getElementById('host-lobby').classList.add('hidden');
                document.getElementById('host-3d').classList.add('hidden');
                document.getElementById('host-2d').classList.add('hidden');

                if (mode === 'flight3d') {
                    document.getElementById('host-3d').classList.remove('hidden');
                    init3DGame();
                } else {
                    document.getElementById('host-2d').classList.remove('hidden');
                    init2DGame(mode);
                }
            };

            window.backToLobby = () => {
                window.location.reload(); // Reset for simplicity
            };

            // --- 3D ENGINE (Three.js) ---
            let scene, camera, renderer, planes = {};
            
            function init3DGame() {
                const container = document.getElementById('game-container-3d');
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x87CEEB);
                scene.fog = new THREE.Fog(0x87CEEB, 10, 500);

                camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
                camera.position.set(0, 50, 100);
                camera.lookAt(0, 0, 0);

                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                container.innerHTML = '';
                container.appendChild(renderer.domElement);

                // Lighting
                const light = new THREE.DirectionalLight(0xffffff, 1);
                light.position.set(50, 100, 50);
                scene.add(light);
                scene.add(new THREE.AmbientLight(0x404040));

                // Ground
                const grid = new THREE.GridHelper(1000, 100, 0x555555, 0xcccccc);
                scene.add(grid);

                animate3D();
            }

            function createPlane(id) {
                const group = new THREE.Group();
                const color = getColor(id);
                
                // Fuselage
                const geo = new THREE.ConeGeometry(2, 8, 8);
                const mat = new THREE.MeshPhongMaterial({ color: color });
                const body = new THREE.Mesh(geo, mat);
                body.rotation.x = Math.PI / 2; // Point forward
                group.add(body);

                // Wings
                const wingGeo = new THREE.BoxGeometry(10, 0.2, 3);
                const wing = new THREE.Mesh(wingGeo, mat);
                group.add(wing);

                scene.add(group);
                return { mesh: group, speed: 0, rotX: 0, rotZ: 0 };
            }

            function animate3D() {
                if (currentMode !== 'flight3d') return;
                requestAnimationFrame(animate3D);

                // Sync players
                Object.keys(players).forEach(id => {
                    const pData = players[id];
                    if (!planes[id]) planes[id] = createPlane(id);
                    
                    const p = planes[id];
                    
                    // Joystick logic (x: roll, y: pitch)
                    if (pData.input) {
                        const roll = -pData.input.x * 0.05;
                        const pitch = pData.input.y * 0.05;
                        
                        p.mesh.rotation.z += roll;
                        p.mesh.rotation.x += pitch;
                        
                        // Move forward based on rotation
                        const speed = pData.action ? 1.5 : 0.8; // Boost
                        p.mesh.translateY(speed); // Cone points Y local
                    }
                });

                // Remove disconnected
                Object.keys(planes).forEach(id => {
                    if (!players[id]) {
                        scene.remove(planes[id].mesh);
                        delete planes[id];
                    }
                });

                renderer.render(scene, camera);
            }


            // --- 2D ENGINE (Canvas) ---
            let ctx, canvas;
            let projectiles = [];

            function init2DGame(mode) {
                canvas = document.getElementById('canvas-2d');
                ctx = canvas.getContext('2d');
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
                projectiles = [];
                
                // Initialize positions for simple games
                Object.keys(players).forEach((id, index) => {
                    players[id].x = 100 + (index * 100);
                    players[id].y = 100;
                    players[id].score = 0;
                });

                animate2D(mode);
            }

            function animate2D(mode) {
                if (currentMode !== mode) return;
                requestAnimationFrame(() => animate2D(mode));

                ctx.fillStyle = '#222';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                Object.keys(players).forEach(id => {
                    const p = players[id];
                    if(!p.x) p.x = canvas.width/2;
                    if(!p.y) p.y = canvas.height/2;

                    const color = '#' + getColor(id).toString(16).padStart(6, '0');
                    ctx.fillStyle = color;

                    // --- GAME LOGIC SWITCHER ---
                    if (mode === 'shooter2d') {
                        // Move
                        if(p.input) {
                            if(p.input.u) p.y -= 3;
                            if(p.input.d) p.y += 3;
                            if(p.input.l) p.x -= 3;
                            if(p.input.r) p.x += 3;
                        }
                        // Shoot
                        if(p.action && !p.cooldown) {
                            projectiles.push({x: p.x, y: p.y, dx: 0, dy: -10, owner: id});
                            p.cooldown = 20;
                        }
                        if(p.cooldown > 0) p.cooldown--;
                        
                        // Draw
                        ctx.beginPath(); ctx.arc(p.x, p.y, 20, 0, Math.PI*2); ctx.fill();
                    } 
                    else if (mode === 'sumo') {
                        // Push logic
                        if (p.action) { // Button mash
                            p.size = (p.size || 30) + 2; 
                            p.action = false; // consume input
                        }
                        if(p.size > 30) p.size -= 0.5; // Shrink
                        
                        ctx.beginPath(); ctx.arc(p.x, p.y, p.size || 30, 0, Math.PI*2); ctx.fill();
                    }
                    else if (mode === 'sniper') {
                        // Gyro Aiming
                        if (p.gyro) {
                            p.x = (canvas.width/2) + p.gyro.gamma * 10;
                            p.y = (canvas.height/2) + p.gyro.beta * 10;
                        }
                        // Draw Crosshair
                        ctx.strokeStyle = color; ctx.lineWidth = 3;
                        ctx.beginPath(); ctx.arc(p.x, p.y, 40, 0, Math.PI*2); ctx.stroke();
                        ctx.moveTo(p.x-50, p.y); ctx.lineTo(p.x+50, p.y); ctx.stroke();
                        ctx.moveTo(p.x, p.y-50); ctx.lineTo(p.x, p.y+50); ctx.stroke();
                    }
                    else if (mode === 'race') {
                        if (p.action) { p.x += 10; p.action = false; }
                        ctx.fillRect(p.x, 50 + Object.keys(players).indexOf(id)*100, 50, 50);
                    }
                });

                // Projectiles (Shooter)
                if (mode === 'shooter2d') {
                    ctx.fillStyle = 'white';
                    projectiles.forEach((proj, i) => {
                        proj.x += proj.dx; proj.y += proj.dy;
                        ctx.fillRect(proj.x, proj.y, 5, 5);
                        if(proj.y < 0 || proj.y > canvas.height) projectiles.splice(i, 1);
                    });
                }
            }
        }

        // --- CONTROLLER LOGIC ---
        else {
            document.getElementById('controller-view').classList.remove('hidden');
            const myRef = ref(db, `rooms/${roomId}/players/${myId}`);
            
            // Disconnect handler
            onDisconnect(myRef).remove();
            
            // Listen to game mode
            onValue(ref(db, `rooms/${roomId}/mode`), (snap) => {
                const mode = snap.val() || 'lobby';
                setupUI(mode);
            });

            function setupUI(mode) {
                // Hide all
                document.getElementById('ui-joystick').classList.add('hidden');
                document.getElementById('ui-dpad').classList.add('hidden');
                document.getElementById('ui-simple').classList.add('hidden');
                document.getElementById('ctrl-title').innerText = mode.toUpperCase();

                if (mode === 'flight3d') {
                    document.getElementById('ui-joystick').classList.remove('hidden');
                    startJoystick();
                } else if (mode === 'shooter2d') {
                    document.getElementById('ui-dpad').classList.remove('hidden');
                } else if (['sumo', 'race', 'paint'].includes(mode)) {
                    document.getElementById('ui-simple').classList.remove('hidden');
                    document.getElementById('simple-instr').innerText = "TAP FAST!";
                } else if (mode === 'sniper') {
                    document.getElementById('ui-simple').classList.remove('hidden');
                    document.getElementById('simple-instr').innerText = "TILT TO AIM, TAP TO SHOOT";
                    startGyro();
                }
            }

            // --- Input Handlers ---
            
            // 1. Joystick
            function startJoystick() {
                const zone = document.getElementById('joystick-zone');
                const knob = document.getElementById('joystick-knob');
                let startX, startY;

                zone.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    startX = touch.clientX;
                    startY = touch.clientY;
                });

                zone.addEventListener('touchmove', (e) => {
                    e.preventDefault();
                    const touch = e.touches[0];
                    let dx = touch.clientX - startX;
                    let dy = touch.clientY - startY;
                    
                    // Clamp
                    const dist = Math.sqrt(dx*dx + dy*dy);
                    const max = 70;
                    if (dist > max) {
                        dx = (dx/dist) * max;
                        dy = (dy/dist) * max;
                    }
                    
                    knob.style.transform = `translate(calc(-50% + ${dx}px), calc(-50% + ${dy}px))`;
                    
                    // Send to Firebase (Normalize -1 to 1)
                    update(myRef, { 
                        input: { x: dx/max, y: dy/max }
                    });
                });

                zone.addEventListener('touchend', () => {
                    knob.style.transform = `translate(-50%, -50%)`;
                    update(myRef, { input: { x: 0, y: 0 } });
                });

                document.getElementById('btn-boost').addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    update(myRef, { action: true });
                });
                document.getElementById('btn-boost').addEventListener('touchend', (e) => {
                    e.preventDefault();
                    update(myRef, { action: false });
                });
            }

            // 2. D-Pad (Shooter)
            const dirs = { u:0, d:0, l:0, r:0 };
            ['up','down','left','right'].forEach(d => {
                const btn = document.getElementById(`d-${d}`);
                btn.addEventListener('touchstart', (e) => { e.preventDefault(); dirs[d[0]] = 1; sendDirs(); });
                btn.addEventListener('touchend', (e) => { e.preventDefault(); dirs[d[0]] = 0; sendDirs(); });
            });
            function sendDirs() { update(myRef, { input: dirs }); }
            
            document.getElementById('btn-fire').addEventListener('touchstart', (e)=>{
                e.preventDefault(); update(myRef, { action: true });
            });
            document.getElementById('btn-fire').addEventListener('touchend', (e)=>{
                e.preventDefault(); update(myRef, { action: false });
            });

            // 3. Simple Tap / Gyro
            document.getElementById('btn-main').addEventListener('touchstart', (e) => {
                e.preventDefault();
                update(myRef, { action: true });
                if(navigator.vibrate) navigator.vibrate(50);
                setTimeout(()=> update(myRef, { action: false }), 100);
            });

            function startGyro() {
                if(typeof DeviceOrientationEvent.requestPermission === 'function') {
                    document.getElementById('btn-main').innerText = "TAP TO START SENSORS";
                    document.getElementById('btn-main').onclick = async () => {
                        await DeviceOrientationEvent.requestPermission();
                        document.getElementById('btn-main').innerText = "FIRE";
                        bindGyro();
                    };
                } else {
