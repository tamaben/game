<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GAKU-QUIZ BATTLE</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/canvas-confetti/1.6.0/confetti.browser.min.js"></script>
    
    <style>
        :root {
            --bg-color: #e0e5ec;
            --shadow-light: #ffffff;
            --shadow-dark: #a3b1c6;
            --primary: #4d79ff;
            --danger: #ff4d4d;
            --success: #00b894;
            --text-main: #4a4a4a;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            overflow: hidden;
            user-select: none;
            touch-action: manipulation;
        }

        .hidden { display: none !important; }
        .full-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        /* --- Neumorphism UI --- */
        .neu-box {
            background: var(--bg-color);
            border-radius: 20px;
            box-shadow: 9px 9px 16px var(--shadow-dark), -9px -9px 16px var(--shadow-light);
            padding: 30px;
            text-align: center;
            max-width: 90%;
        }

        .neu-btn {
            border: none;
            outline: none;
            background: var(--bg-color);
            border-radius: 15px;
            box-shadow: 6px 6px 10px var(--shadow-dark), -6px -6px 10px var(--shadow-light);
            color: var(--primary);
            font-weight: bold;
            padding: 15px 30px;
            margin: 10px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
            -webkit-tap-highlight-color: transparent;
        }

        .neu-btn:active, .neu-btn.active {
            box-shadow: inset 6px 6px 10px var(--shadow-dark), inset -6px -6px 10px var(--shadow-light);
            transform: translateY(2px);
        }

        .neu-input {
            border: none;
            background: var(--bg-color);
            border-radius: 10px;
            box-shadow: inset 6px 6px 10px var(--shadow-dark), inset -6px -6px 10px var(--shadow-light);
            padding: 15px;
            font-size: 1.2rem;
            text-align: center;
            width: 80%;
            margin-bottom: 20px;
            color: var(--text-main);
            outline: none;
        }

        /* --- HOST SCREENS --- */
        #host-lobby h1 { font-size: 3rem; color: var(--primary); text-shadow: 2px 2px 4px rgba(0,0,0,0.1); margin-bottom: 10px;}
        .subject-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px; max-height: 50vh; overflow-y: auto; padding: 10px; }
        .subject-card { cursor: pointer; height: 80px; display: flex; align-items: center; justify-content: center; font-size: 1.3rem; }
        
        #game-screen { width: 90%; max-width: 1000px; }
        #timer-bar-container {
            width: 100%; height: 20px; border-radius: 10px;
            box-shadow: inset 6px 6px 10px var(--shadow-dark), inset -6px -6px 10px var(--shadow-light);
            margin-bottom: 20px; overflow: hidden; position: relative;
        }
        #timer-bar {
            height: 100%; width: 100%; background: linear-gradient(90deg, #4d79ff, #00b894);
            border-radius: 10px; transition: width 0.1s linear;
        }

        #question-text { font-size: 2.2rem; font-weight: 900; margin: 30px 0; min-height: 100px; line-height: 1.4; display:flex; align-items:center; justify-content:center;}
        
        .answer-display { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%; }
        .ans-option { 
            padding: 20px; font-size: 1.5rem; border-radius: 15px; 
            box-shadow: 6px 6px 10px var(--shadow-dark), -6px -6px 10px var(--shadow-light);
            opacity: 0.8;
            display: flex; align-items: center; justify-content: center;
            transition: transform 0.3s;
        }
        .ans-option.correct { background-color: var(--success); color: white; opacity: 1; transform: scale(1.05); box-shadow: none; }
        .ans-option.dim { opacity: 0.2; transform: scale(0.95); }

        /* --- CONTROLLER SCREENS --- */
        #controller-view { background: #333; color: white; }
        .ctl-grid { display:grid; grid-template-columns:1fr 1fr; gap:20px; width:90%; height:60vh; }
        .ctl-btn { 
            width: 100%; height: 100%; border-radius: 20px; border: none; 
            font-size: 3rem; font-weight: bold; color: white;
            box-shadow: 0 10px 20px rgba(0,0,0,0.3);
            display: flex; align-items: center; justify-content: center;
        }
        .ctl-btn:active { transform: scale(0.92); box-shadow: 0 5px 10px rgba(0,0,0,0.3); }
        .ctl-btn:disabled { filter: grayscale(100%); opacity: 0.4; cursor: not-allowed; transform: none; }
        
        .c-red { background: #ff5252; } .c-blue { background: #448aff; }
        .c-yellow { background: #ffd740; color: #333; } .c-green { background: #69f0ae; color: #333; }

        /* --- RESULT --- */
        .ranking-item { 
            display: flex; justify-content: space-between; padding: 15px; 
            border-bottom: 1px solid rgba(0,0,0,0.1); font-size: 1.5rem; 
        }
        .ranking-item:nth-child(1) { color: #d4af37; font-weight: bold; font-size: 2rem; text-shadow: 1px 1px 0px rgba(0,0,0,0.2); }

        /* Error Message */
        #error-msg { color: var(--danger); font-weight: bold; margin-top: 20px; font-size: 14px; }
    </style>
</head>
<body>

    <div id="room-info" style="position:fixed; top:10px; left:10px; opacity:0.5; font-size:12px; z-index:1000;">Loading...</div>

    <div id="host-lobby" class="full-screen hidden">
        <div class="neu-box">
            <h1>GAKU-QUIZ</h1>
            <div style="display:flex; flex-direction:column; align-items:center; gap:20px;">
                <div id="qrcode" style="padding:15px; background:white; border-radius:15px; box-shadow: inset 0 0 10px rgba(0,0,0,0.1);"></div>
                <div>
                    <p style="font-size:1.1rem; margin-bottom:5px;">ã‚¹ãƒãƒ›ã®ã‚«ãƒ¡ãƒ©ã§ã‚¹ã‚­ãƒ£ãƒ³</p>
                    <h2 id="player-count" style="color:var(--primary);">å‚åŠ è€…: 0äºº</h2>
                </div>
            </div>
            <div id="error-msg"></div>
            
            <h3 style="margin-top:30px; border-bottom: 2px solid #ccc; padding-bottom:5px;">æ•™ç§‘ã‚’é¸æŠ</h3>
            <div class="subject-grid" id="subject-selector">
                <div>èª­ã¿è¾¼ã¿ä¸­...</div>
            </div>
        </div>
    </div>

    <div id="host-game" class="full-screen hidden">
        <div id="game-screen" class="neu-box">
            <h2 id="current-subject" style="color:var(--primary); margin:0;">æ•™ç§‘</h2>
            <div id="question-counter" style="color:#888;">Q 1</div>
            
            <div id="question-text">Loading Question...</div>
            
            <div id="timer-bar-container">
                <div id="timer-bar"></div>
            </div>

            <div class="answer-display">
                <div class="ans-option" id="opt-0">A</div>
                <div class="ans-option" id="opt-1">B</div>
                <div class="ans-option" id="opt-2">C</div>
                <div class="ans-option" id="opt-3">D</div>
            </div>
        </div>
    </div>

    <div id="host-result" class="full-screen hidden">
        <div class="neu-box" style="width: 80%; max-width:600px;">
            <h1 id="result-title">ğŸ† çµæœç™ºè¡¨ ğŸ†</h1>
            <div id="ranking-list" style="text-align:left; max-height: 400px; overflow-y:auto; padding:10px;">
                </div>
            <button class="neu-btn" onclick="location.reload()" style="margin-top:20px;">ã‚¿ã‚¤ãƒˆãƒ«ã¸æˆ»ã‚‹</button>
        </div>
    </div>

    <div id="ctrl-login" class="full-screen hidden">
        <div class="neu-box">
            <h2>åå‰ã‚’å…¥åŠ›</h2>
            <input type="text" id="p-name" class="neu-input" placeholder="ãƒ‹ãƒƒã‚¯ãƒãƒ¼ãƒ " maxlength="8">
            <br>
            <button class="neu-btn" onclick="joinGame()">å‚åŠ ã™ã‚‹</button>
        </div>
    </div>

    <div id="ctrl-wait" class="full-screen hidden" style="background:#2c3e50; color:white;">
        <div style="text-align:center;">
            <h2 style="font-size:2rem;">WAITING...</h2>
            <p id="wait-text">ãƒ›ã‚¹ãƒˆã®æ“ä½œã‚’å¾…ã£ã¦ã„ã¾ã™</p>
        </div>
    </div>

    <div id="ctrl-buttons" class="full-screen hidden" style="background:#222;">
        <div class="ctl-grid">
            <button class="ctl-btn c-red" onclick="sendAns(0)">A</button>
            <button class="ctl-btn c-blue" onclick="sendAns(1)">B</button>
            <button class="ctl-btn c-yellow" onclick="sendAns(2)">C</button>
            <button class="ctl-btn c-green" onclick="sendAns(3)">D</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, update, onValue, onDisconnect, set, remove } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        // Firebaseè¨­å®š
        const firebaseConfig = {
            apiKey: "AIzaSyDbZzTMvUkG2LXIGY4ux0KBTmnAdqP236s",
            authDomain: "game-4f2d9.firebaseapp.com",
            databaseURL: "https://game-4f2d9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "game-4f2d9"
        };

        let app, db;
        try {
            app = initializeApp(firebaseConfig);
            db = getDatabase(app);
        } catch(e) {
            alert("Firebaseæ¥ç¶šã‚¨ãƒ©ãƒ¼: ã‚¤ãƒ³ã‚¿ãƒ¼ãƒãƒƒãƒˆæ¥ç¶šã‚’ç¢ºèªã—ã¦ãã ã•ã„");
        }

        // --- GLOBAL VARIABLES ---
        let QUIZ_DATABASE = null;
        const params = new URLSearchParams(window.location.search);
        let role = params.get('role');
        let roomId = params.get('room');
        const myId = Math.random().toString(36).substr(2, 6);
        let qList = [];
        let qIndex = 0;
        let timerId = null;

        // --- MAIN ENTRY POINT ---
        // ãƒ­ãƒ¼ãƒ«åˆ¤å®šã‚’æœ€åˆã«è¡Œã„ã€ã‚¹ãƒãƒ›ãªã‚‰JSONã‚’èª­ã¿è¾¼ã¾ã›ãªã„ï¼ˆãƒã‚°å›é¿ï¼‰
        if (!role) {
            // Roleãªã— -> ãƒ›ã‚¹ãƒˆã¨ã—ã¦åˆæœŸåŒ–ï¼ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆï¼‰
            roomId = Math.random().toString(36).substring(2, 6).toUpperCase();
            window.location.replace(`?role=host&room=${roomId}`);
        } else if (role === 'host') {
            document.getElementById('room-info').innerText = `HOST ID: ${roomId}`;
            initHost(); // ãƒ›ã‚¹ãƒˆã¯JSONèª­ã¿è¾¼ã¿ãŒå¿…è¦
        } else {
            document.getElementById('room-info').innerText = `CLIENT`;
            initClient(); // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯JSONä¸è¦
        }

        // =======================
        //      HOST LOGIC
        // =======================
        async function initHost() {
            document.getElementById('host-lobby').classList.remove('hidden');

            // 1. QRã‚³ãƒ¼ãƒ‰ç”Ÿæˆ
            // é‡è¦: PCã®ãƒ­ãƒ¼ã‚«ãƒ«IPã‚„file://ã¯ã‚¹ãƒãƒ›ã‹ã‚‰è¦‹ãˆã¾ã›ã‚“ã€‚Webã‚µãƒ¼ãƒãƒ¼ãŒå¿…è¦ã§ã™ã€‚
            const url = `${window.location.origin}${window.location.pathname}?role=ctrl&room=${roomId}`;
            new QRCode(document.getElementById("qrcode"), { text: url, width: 150, height: 150 });
            
            // è­¦å‘Š: file:// ã§é–‹ã„ã¦ã„ã‚‹å ´åˆ
            if(window.location.protocol === 'file:') {
                document.getElementById('error-msg').innerHTML = "âš  æ³¨æ„: ãƒ­ãƒ¼ã‚«ãƒ«ãƒ•ã‚¡ã‚¤ãƒ«(file://)ã§é–‹ã„ã¦ã„ã¾ã™ã€‚<br>ã‚¹ãƒãƒ›ã‹ã‚‰æ¥ç¶šã™ã‚‹ã«ã¯VS Codeã®Live Serverç­‰ã‚’ä½¿ç”¨ã—ã¦ãã ã•ã„ã€‚";
            }

            // 2. DBåˆæœŸåŒ–
            update(ref(db, `rooms/${roomId}`), { status: 'lobby', qIndex: -1 });
            remove(ref(db, `rooms/${roomId}/players`));

            // 3. ãƒ—ãƒ¬ã‚¤ãƒ¤ãƒ¼ç›£è¦–
            onValue(ref(db, `rooms/${roomId}/players`), (snap) => {
                const players = snap.val() || {};
                document.getElementById('player-count').innerText = `å‚åŠ è€…: ${Object.keys(players).length}äºº`;
            });

            // 4. JSONãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
            try {
                const response = await fetch('quiz_data.json');
                if (!response.ok) throw new Error("JSON Not Found");
                QUIZ_DATABASE = await response.json();
                
                // ãƒœã‚¿ãƒ³ç”Ÿæˆ
                const selector = document.getElementById('subject-selector');
                selector.innerHTML = '';
                Object.keys(QUIZ_DATABASE).forEach(key => {
                    const sub = QUIZ_DATABASE[key];
                    const div = document.createElement('div');
                    div.className = 'neu-btn subject-card';
                    div.innerText = sub.name;
                    div.onclick = () => startSubject(key);
                    selector.appendChild(div);
                });

            } catch (error) {
                console.error(error);
                document.getElementById('subject-selector').innerHTML = `
                    <div style="grid-column: 1/-1; color:red;">
                        ã‚¨ãƒ©ãƒ¼: quiz_data.json ãŒèª­ã¿è¾¼ã‚ã¾ã›ã‚“ã€‚<br>
                        ã‚µãƒ¼ãƒãƒ¼çµŒç”±ã§é–‹ã„ã¦ã„ã¾ã™ã‹ï¼Ÿ
                    </div>`;
            }
        }

        window.startSubject = (key) => {
            if(!QUIZ_DATABASE) return;
            const currentSubject = QUIZ_DATABASE[key];
            qList = currentSubject.questions;
            qIndex = 0;
            
            document.getElementById('host-lobby').classList.add('hidden');
            document.getElementById('host-game').classList.remove('hidden');
            document.getElementById('current-subject').innerText = currentSubject.name;
            
            runQuestion();
        };

        function runQuestion() {
            if (qIndex >= qList.length) {
                endGame();
                return;
            }

            const q = qList[qIndex];
            
            // UIæ›´æ–°
            document.getElementById('question-counter').innerText = `Q ${qIndex + 1} / ${qList.length}`;
            document.getElementById('question-text').innerText = q.q;
            
            // é¸æŠè‚¢ã®ãƒªã‚»ãƒƒãƒˆ
            q.opts.forEach((txt, i) => {
                const el = document.getElementById(`opt-${i}`);
                el.innerText = txt;
                el.className = 'ans-option'; // ã‚¯ãƒ©ã‚¹ãƒªã‚»ãƒƒãƒˆ
            });

            // DBæ›´æ–°ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¸é€šçŸ¥ï¼‰
            update(ref(db, `rooms/${roomId}`), {
                status: 'question',
                startTime: Date.now(),
                limit: q.time,
                qIndex: qIndex
            });

            // ã‚¿ã‚¤ãƒãƒ¼å§‹å‹•
            let timeLeft = q.time;
            const bar = document.getElementById('timer-bar');
            bar.style.width = '100%';
            bar.style.background = 'linear-gradient(90deg, #4d79ff, #00b894)';

            if(timerId) clearInterval(timerId); // å¤ã„ã‚¿ã‚¤ãƒãƒ¼ã‚’æ¶ˆã™
            timerId = setInterval(() => {
                timeLeft -= 0.1;
                const pct = (timeLeft / q.time) * 100;
                bar.style.width = `${pct}%`;

                if (timeLeft <= 3) bar.style.background = '#ff4d4d';

                if (timeLeft <= 0) {
                    clearInterval(timerId);
                    showAnswer();
                }
            }, 100);
        }

        function showAnswer() {
            const q = qList[qIndex];
            const correctIdx = q.ans;
            
            // æ­£è§£è¡¨ç¤º
            document.getElementById(`opt-${correctIdx}`).classList.add('correct');
            [0,1,2,3].forEach(i => {
                if (i !== correctIdx) document.getElementById(`opt-${i}`).classList.add('dim');
            });

            // DBæ›´æ–°ï¼ˆã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆæ“ä½œãƒ­ãƒƒã‚¯ï¼‰
            update(ref(db, `rooms/${roomId}`), { status: 'result' });

            // é›†è¨ˆå‡¦ç†ï¼ˆå°‘ã—å¾…ã£ã¦ã‹ã‚‰å®Ÿè¡Œï¼‰
            setTimeout(() => {
                gradeAndNext();
            }, 3000); 
        }

        function gradeAndNext() {
            onValue(ref(db, `rooms/${roomId}/players`), (snap) => {
                const players = snap.val() || {};
                const q = qList[qIndex];
                const updates = {};

                Object.keys(players).forEach(pid => {
                    const p = players[pid];
                    let currentScore = p.score || 0;
                    
                    // lastAnsãŒå­˜åœ¨ã—ã€ã‹ã¤æ­£è§£ã¨ä¸€è‡´ã™ã‚‹ã‹
                    if (p.lastAns !== undefined && p.lastAns === q.ans) {
                        currentScore += 10;
                    }
                    updates[`${pid}/score`] = currentScore;
                    updates[`${pid}/lastAns`] = null; // æ¬¡ã®ãŸã‚ã«ãƒªã‚»ãƒƒãƒˆ
                });
                
                update(ref(db, `rooms/${roomId}/players`), updates).then(() => {
                    qIndex++;
                    runQuestion();
                });
            }, { onlyOnce: true });
        }

        function endGame() {
            document.getElementById('host-game').classList.add('hidden');
            document.getElementById('host-result').classList.remove('hidden');
            
            update(ref(db, `rooms/${roomId}`), { status: 'finish' });
            
            confetti({ particleCount: 200, spread: 80, origin: { y: 0.6 } });

            onValue(ref(db, `rooms/${roomId}/players`), (snap) => {
                const players = snap.val() || {};
                const sorted = Object.values(players).sort((a,b) => b.score - a.score);
                
                const list = document.getElementById('ranking-list');
                list.innerHTML = '';
                
                sorted.forEach((p, i) => {
                    const div = document.createElement('div');
                    div.className = 'ranking-item';
                    let icon = i === 0 ? 'ğŸ‘‘ ' : i === 1 ? 'ğŸ¥ˆ ' : i === 2 ? 'ğŸ¥‰ ' : ' ';
                    div.innerHTML = `<span>${icon}${i+1}. ${p.name}</span> <span>${p.score}pt</span>`;
                    list.appendChild(div);
                });
            });
        }

        // =======================
        //      CLIENT LOGIC
        // =======================
        function initClient() {
            // ã‚¯ãƒ©ã‚¤ã‚¢ãƒ³ãƒˆã¯JSONèª­ã¿è¾¼ã¿ã‚’å¾…ãŸãšã«å³åº§ã«ãƒ­ã‚°ã‚¤ãƒ³ç”»é¢ã‚’è¡¨ç¤º
            document.getElementById('ctrl-login').classList.remove('hidden');
        }

        window.joinGame = () => {
            const name = document.getElementById('p-name').value || "åç„¡ã—";
            const myRef = ref(db, `rooms/${roomId}/players/${myId}`);
            
            set(myRef, {
                name: name,
                score: 0,
                lastAns: null
            });
            onDisconnect(myRef).remove(); // åˆ‡æ–­æ™‚ã«å‰Šé™¤

            document.getElementById('ctrl-login').classList.add('hidden');
            document.getElementById('ctrl-wait').classList.remove('hidden');

            // ã‚²ãƒ¼ãƒ çŠ¶æ…‹ã®ç›£è¦–
            onValue(ref(db, `rooms/${roomId}`), (snap) => {
                const state = snap.val();
                if (!state) {
                    alert("éƒ¨å±‹ãŒå­˜åœ¨ã—ã¾ã›ã‚“ã€‚QRã‚³ãƒ¼ãƒ‰ã‚’èª­ã¿ç›´ã—ã¦ãã ã•ã„ã€‚");
                    return;
                }

                if (state.status === 'lobby') {
                    showClientScreen('ctrl-wait');
                    document.getElementById('wait-text').innerText = "ãƒ›ã‚¹ãƒˆãŒæº–å‚™ä¸­ã§ã™...";
                } else if (state.status === 'question') {
                    showClientScreen('ctrl-buttons');
                    enableButtons(true);
                } else if (state.status === 'result') {
                    enableButtons(false);
                    // ã“ã“ã§ã€‡âœ•ã‚’è¡¨ç¤ºã™ã‚‹ã“ã¨ã‚‚å¯èƒ½
                } else if (state.status === 'finish') {
                    showClientScreen('ctrl-wait');
                    document.getElementById('wait-text').innerText = "çµæœç™ºè¡¨ä¸­ï¼\nãƒ›ã‚¹ãƒˆç”»é¢ã‚’è¦‹ã¦ã­";
                }
            });
        };

        function showClientScreen(id) {
            ['ctrl-login', 'ctrl-wait', 'ctrl-buttons'].forEach(i => document.getElementById(i).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        window.sendAns = (idx) => {
            if (navigator.vibrate) navigator.vibrate(50);
            enableButtons(false); // é€£æ‰“é˜²æ­¢
            update(ref(db, `rooms/${roomId}/players/${myId}`), { lastAns: idx });
        };

        function enableButtons(on) {
            const btns = document.querySelectorAll('.ctl-btn');
            btns.forEach(b => {
                b.disabled = !on;
                if(on) {
                    b.style.transform = "scale(1)";
                    b.style.opacity = "1";
                    b.style.filter = "none";
                }
            });
        }

    </script>
</body>
</html>
