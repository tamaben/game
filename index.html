<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>JOY-CON WEREWOLF: ULTIMATE</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --neon-red: #ff003c; --neon-blue: #00e5ff; --gold: #ffd700; }
        body { background: #050505; color: white; font-family: 'Press Start 2P', cursive, sans-serif; margin: 0; overflow: hidden; }
        
        /* メインステージ */
        #stage { width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; background: radial-gradient(circle, #1a1a2e 0%, #000 100%); }
        
        /* プレイヤーの円陣 */
        .player-ring { position: relative; width: 700px; height: 700px; border-radius: 50%; border: 1px solid rgba(0,229,255,0.2); transition: all 1s ease; }
        .p-node { position: absolute; width: 100px; transition: all 0.5s; }
        .joycon-visual { width: 40px; height: 100px; border-radius: 12px; margin: 0 auto; border: 3px solid #333; position: relative; box-shadow: 0 0 15px rgba(0,0,0,0.5); }
        .p-name { font-size: 10px; margin-top: 10px; text-shadow: 0 0 5px #fff; }

        /* レーザー（投票ポインティング） */
        .laser { position: absolute; height: 2px; transform-origin: left center; pointer-events: none; z-index: 5; opacity: 0; transition: opacity 0.2s; }

        /* 特殊エフェクト */
        .panic-mode { animation: panic 0.1s infinite; }
        @keyframes panic { 0% { filter: hue-rotate(0deg); } 100% { filter: hue-rotate(360deg); } }

        /* UIパネル */
        #ui-top { position: absolute; top: 20px; left: 50%; transform: translateX(-50%); text-align: center; }
        #phase-display { font-size: 40px; color: var(--neon-red); text-shadow: 0 0 20px var(--neon-red); }
        #log-panel { position: absolute; bottom: 20px; left: 20px; width: 300px; font-size: 10px; color: #00e5ff; background: rgba(0,0,0,0.5); padding: 10px; }
    </style>
</head>
<body>

<div id="stage">
    <div id="ui-top">
        <div id="phase-display">WAITING...</div>
        <div id="room-info">ROOM ID: <span id="room-id">----</span></div>
    </div>

    <div class="player-ring" id="ring">
        <!-- プレイヤーが動的に配置される -->
    </div>

    <div id="log-panel">SYSTEM READY...</div>

    <div id="qr-area" style="position: absolute; top: 20px; right: 20px; background: white; padding: 10px; border-radius: 10px;">
        <div id="qrcode"></div>
    </div>

    <div style="position: absolute; bottom: 20px; right: 20px;">
        <button onclick="connectHID()" style="padding: 10px; background: var(--neon-blue); border: none; cursor: pointer;">JOY-CONを同期</button>
        <button onclick="nextPhase()" style="padding: 10px; background: var(--neon-red); border: none; cursor: pointer; color: white;">フェーズ進捗</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

    const firebaseConfig = { /* 省略：前のコードと同じ */ };
    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const roomId = Math.random().toString(36).substring(2, 6).toUpperCase();
    document.getElementById('room-id').innerText = roomId;

    let players = {};
    let joyconMap = new Map(); // PlayerID -> HID Device

    // QRコード
    new QRCode(document.getElementById("qrcode"), { text: `${window.location.origin}${window.location.pathname}?r=${roomId}`, width: 80, height: 80 });

    // --- 究極のWeb HID 制御 ---
    window.connectHID = async () => {
        const devices = await navigator.hid.requestDevice({
            filters: [{ vendorId: 0x057e, productId: 0x2006 }, { vendorId: 0x057e, productId: 0x2007 }]
        });
        
        for (const device of devices) {
            await device.open();
            // ジャイロと振動をフルパワーで有効化
            await device.sendReport(0x01, new Uint8Array([0x01, 0, 0, 0, 0, 0, 0, 0, 0, 0x40, 0x01])); // Enable IMU
            await device.sendReport(0x01, new Uint8Array([0x01, 0, 0, 0, 0, 0, 0, 0, 0, 0x30, 0x03])); // Standard full mode
            
            const side = device.productId === 0x2006 ? 'L' : 'R';
            joyconMap.set(side, device); // 実際は参加順に紐付け
            
            // 接続完了の「鼓動」振動
            sendRumble(device, "heartbeat");
            addLog(`${device.productName} 接続完了`);

            // ジャイロデータの受信とポインティング
            device.oninputreport = (e) => handleJoyconData(device, e);
        }
    };

    function handleJoyconData(device, event) {
        const data = new DataView(event.data.buffer);
        // ボタン取得
        const btn = data.getUint8(3);
        if (btn & 0x08) { // X or Up button
            addLog("VOTE TRIGGERED!");
            sendRumble(device, "click");
        }
        
        // ジャイロによる傾き検知（ポインティングのシミュレーション）
        const gyroY = data.getInt16(19, true); 
        // この値をFirebaseに送ってレーザーを表示させる
    }

    // --- 物理振動演出（HD振動を模倣） ---
    async function sendRumble(device, type) {
        let rumbleData;
        if (type === "heartbeat") {
            rumbleData = new Uint8Array([0x10, 0x00, 0x01, 0x40, 0x40, 0x00, 0x01, 0x40, 0x40]);
        } else if (type === "die") {
            rumbleData = new Uint8Array([0x10, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff]); // 強烈な振動
        } else {
            rumbleData = new Uint8Array([0x10, 0x00, 0x50, 0x40, 0x40, 0x00, 0x50, 0x40, 0x40]);
        }
        await device.sendReport(0x01, rumbleData);
    }

    // --- ゲーム同期 ---
    onValue(ref(db, `rooms/${roomId}/players`), (snapshot) => {
        players = snapshot.val() || {};
        const ring = document.getElementById('ring');
        ring.innerHTML = '<div id="center-ui"></div>'; // クリア
        
        const ids = Object.keys(players);
        ids.forEach((id, i) => {
            const p = players[id];
            const angle = (i / ids.length) * 2 * Math.PI;
            const x = Math.cos(angle) * 300;
            const y = Math.sin(angle) * 300;

            const div = document.createElement('div');
            div.className = `p-node ${p.alive ? '' : 'dead'}`;
            div.style.left = `calc(50% + ${x}px - 50px)`;
            div.style.top = `calc(50% + ${y}px - 60px)`;
            div.innerHTML = `
                <div class="joycon-visual" style="background:${p.color}; box-shadow: 0 0 20px ${p.color}">
                    <div style="position:absolute; top:10px; left:50%; transform:translateX(-50%); color:white; font-size:8px;">${p.role==='人狼'?'☠️':''}</div>
                </div>
                <div class="p-name">${p.name}</div>
            `;
            ring.appendChild(div);
        });
    });

    function addLog(msg) {
        const log = document.getElementById('log-panel');
        log.innerHTML = `> ${msg}<br>` + log.innerHTML;
    }

    window.nextPhase = () => { /* フェーズ切り替えロジック：前のコードを強化 */ };
</script>
</body>
</html>
