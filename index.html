<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Multi-Game Party + Kanji Quiz</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
    <style>
        body { font-family: 'Hiragino Kaku Gothic ProN', 'Meiryo', sans-serif; margin: 0; background: #111; color: white; overflow: hidden; touch-action: none; }
        .hidden { display: none !important; }
        .full-screen { position: absolute; top:0; left:0; width: 100vw; height: 100vh; display: flex; flex-direction: column; align-items: center; justify-content: center; }

        /* --- UI: ÂÖ±ÈÄö --- */
        #room-info { position: absolute; top: 10px; left: 10px; z-index: 100; font-size: 14px; color: #aaa; background: rgba(0,0,0,0.5); padding: 5px 10px; border-radius: 4px; }
        
        /* --- UI: „Éõ„Çπ„ÉàÔºàPCÔºâ --- */
        #host-lobby { background: linear-gradient(135deg, #1a2a6c, #b21f1f, #fdbb2d); z-index: 10; text-align: center; }
        #game-menu { display: grid; grid-template-columns: repeat(3, 1fr); gap: 15px; margin-top: 20px; max-width: 800px; }
        .game-card { background: rgba(255,255,255,0.1); padding: 20px; border-radius: 10px; cursor: pointer; border: 2px solid transparent; transition: 0.2s; }
        .game-card:hover { background: rgba(255,255,255,0.3); transform: scale(1.05); border-color: #fff; }
        .game-title { font-weight: bold; font-size: 18px; margin-bottom: 5px; }
        
        #game-container-3d, #game-container-2d { width: 100%; height: 100%; background: #000; }
        
        /* --- UI: „ÇØ„Ç§„Ç∫ÁîªÈù¢Ôºà„Éõ„Çπ„ÉàÔºâ --- */
        #host-quiz { background: #2c3e50; width: 100%; height: 100%; display: flex; flex-direction: column; align-items: center; justify-content: center; }
        .quiz-container { text-align: center; width: 80%; }
        .quiz-question { font-size: 48px; margin-bottom: 30px; font-weight: bold; text-shadow: 2px 2px 4px #000; }
        .quiz-options { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px; }
        .quiz-opt { background: #34495e; padding: 20px; border-radius: 10px; font-size: 24px; border: 2px solid #555; }
        .quiz-opt.correct { background: #27ae60; border-color: #2ecc71; animation: blink 0.5s infinite; }
        .quiz-timer { width: 100%; height: 10px; background: #555; border-radius: 5px; margin-top: 20px; overflow: hidden; }
        .quiz-bar { height: 100%; background: #e74c3c; width: 100%; transition: width 0.1s linear; }
        #quiz-status { font-size: 32px; color: #f1c40f; margin-bottom: 20px; min-height: 40px; }
        #quiz-ranking { position: absolute; top: 20px; right: 20px; text-align: right; font-size: 18px; }

        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0.7; } 100% { opacity: 1; } }

        /* --- UI: „Ç≥„É≥„Éà„É≠„Éº„É©„ÉºÔºà„Çπ„Éû„ÉõÔºâ --- */
        #controller-view { background: #222; }
        
        /* „ÇØ„Ç§„Ç∫Áî®„Éú„Çø„É≥ */
        #ui-quiz { width: 100%; height: 100%; padding: 20px; box-sizing: border-box; display: flex; flex-direction: column; }
        .quiz-grid { display: grid; grid-template-columns: 1fr 1fr; grid-template-rows: 1fr 1fr; gap: 15px; flex-grow: 1; }
        .q-btn { border: none; border-radius: 15px; font-size: 32px; font-weight: bold; color: white; box-shadow: 0 4px 0 rgba(0,0,0,0.3); }
        .q-btn:active { transform: translateY(4px); box-shadow: none; }
        .btn-a { background: #e74c3c; } /* Red */
        .btn-b { background: #3498db; } /* Blue */
        .btn-c { background: #f1c40f; color: #333; } /* Yellow */
        .btn-d { background: #2ecc71; } /* Green */
        #quiz-feedback { text-align: center; font-size: 24px; margin-bottom: 10px; height: 30px; }

        /* Êó¢Â≠ò„ÅÆ„Ç∏„Éß„Ç§„Çπ„ÉÜ„Ç£„ÉÉ„ÇØÁ≠â */
        #joystick-zone { width: 300px; height: 300px; background: rgba(255,255,255,0.1); border-radius: 50%; position: relative; margin-bottom: 20px; border: 2px solid rgba(255,255,255,0.2); }
        #joystick-knob { width: 80px; height: 80px; background: #00d4ff; border-radius: 50%; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); box-shadow: 0 0 15px #00d4ff; pointer-events: none; }
        
        #dpad-zone { display: grid; grid-template-columns: 1fr 1fr 1fr; gap: 10px; margin-bottom: 20px; }
        .d-btn { width: 70px; height: 70px; background: #444; border-radius: 10px; border: none; font-size: 24px; color: white; }
        .d-btn:active { background: #666; }
        
        .action-btn { width: 120px; height: 120px; border-radius: 50%; background: #ff4757; color: white; border: none; font-weight: bold; font-size: 20px; margin-top: 20px; box-shadow: 0 5px #c0392b; }
        .action-btn:active { transform: translateY(5px); box-shadow: 0 0px #c0392b; }

        /* „Éó„É¨„Ç§„É§„Éº„É™„Çπ„Éà */
        #player-list { margin-top: 20px; font-size: 14px; color: #ddd; }
    </style>
</head>
<body>

    <div id="room-info">Loading...</div>

    <div id="host-lobby" class="full-screen hidden">
        <h1>GAME SELECTOR</h1>
        <div id="qrcode" style="background: white; padding: 10px; border-radius: 8px;"></div>
        <p>„Çπ„Éû„Éõ„Åß„Çπ„Ç≠„É£„É≥„Åó„Å¶ÂèÇÂä†ÔºÅ</p>
        
        <div id="game-menu">
            <div class="game-card" onclick="selectGame('quiz')">
                <div class="game-title">üÄÑ Êº¢Â≠ó„ÇØ„Ç§„Ç∫</div>
                <div class="desc">‰∏≠Â≠¶„É¨„Éô„É´1000Êú¨„Éé„ÉÉ„ÇØ</div>
            </div>
            <div class="game-card" onclick="selectGame('flight3d')">
                <div class="game-title">‚úàÔ∏è 3D SKY BATTLE</div>
                <div class="desc">3DÁ©∫Èñì„ÇíËá™Áî±„Å´È£õË°å</div>
            </div>
            <div class="game-card" onclick="selectGame('shooter2d')">
                <div class="game-title">üî´ 2D SHOOTER</div>
                <div class="desc">ÂÖ®ÊñπÂêë„Ç∑„É•„Éº„ÉÜ„Ç£„É≥„Ç∞</div>
            </div>
            <div class="game-card" onclick="selectGame('sumo')">
                <div class="game-title">ü§º CIRCLE SUMO</div>
                <div class="desc">‰ΩìÂΩì„Åü„Çä„ÅßËêΩ„Å®„ÅóÂêà„ÅÑ</div>
            </div>
            <div class="game-card" onclick="selectGame('paint')">
                <div class="game-title">üé® PAINT WAR</div>
                <div class="desc">Â∫ä„ÇíËá™ÂàÜ„ÅÆËâ≤„Å´Â°ó„Çå</div>
            </div>
            <div class="game-card" onclick="selectGame('sniper')">
                <div class="game-title">üéØ GYRO SNIPER</div>
                <div class="desc">„Çπ„Éû„Éõ„ÇíÂÇæ„Åë„Å¶ÁãôÊíÉ</div>
            </div>
        </div>
        <div id="player-list">ÂèÇÂä†ËÄÖÂæÖÊ©ü‰∏≠...</div>
    </div>

    <div id="host-3d" class="full-screen hidden">
        <div id="game-container-3d"></div>
        <button onclick="backToLobby()" style="position: absolute; top:10px; right:10px; z-index: 100;">MENU</button>
    </div>

    <div id="host-2d" class="full-screen hidden">
        <canvas id="canvas-2d"></canvas>
        <button onclick="backToLobby()" style="position: absolute; top:10px; right:10px; z-index: 100;">MENU</button>
    </div>

    <div id="host-quiz" class="full-screen hidden">
        <div id="quiz-ranking"></div>
        <div class="quiz-container">
            <div id="quiz-status">Ê∫ñÂÇô‰∏≠...</div>
            <div class="quiz-question" id="q-text">ÂïèÈ°åÊñá„Åå„Åì„Åì„Å´Ë°®Á§∫„Åï„Çå„Åæ„Åô</div>
            <div class="quiz-options">
                <div class="quiz-opt" id="opt-0">A: ÈÅ∏ÊäûËÇ¢1</div>
                <div class="quiz-opt" id="opt-1">B: ÈÅ∏ÊäûËÇ¢2</div>
                <div class="quiz-opt" id="opt-2">C: ÈÅ∏ÊäûËÇ¢3</div>
                <div class="quiz-opt" id="opt-3">D: ÈÅ∏ÊäûËÇ¢4</div>
            </div>
            <div class="quiz-timer"><div class="quiz-bar" id="q-bar"></div></div>
        </div>
        <button onclick="backToLobby()" style="position: absolute; top:10px; right:10px; z-index: 100;">MENU</button>
    </div>

    <div id="controller-view" class="full-screen hidden">
        <h2 id="ctrl-title" style="margin-bottom: 20px;">WAITING...</h2>
        
        <div id="ui-quiz" class="hidden">
            <div id="quiz-feedback"></div>
            <div class="quiz-grid">
                <button class="q-btn btn-a" onclick="sendAnswer(0)">A</button>
                <button class="q-btn btn-b" onclick="sendAnswer(1)">B</button>
                <button class="q-btn btn-c" onclick="sendAnswer(2)">C</button>
                <button class="q-btn btn-d" onclick="sendAnswer(3)">D</button>
            </div>
        </div>

        <div id="ui-joystick" class="hidden">
            <div id="joystick-zone">
                <div id="joystick-knob"></div>
            </div>
            <p>Drag to Fly</p>
            <button class="action-btn" id="btn-boost">BOOST</button>
        </div>

        <div id="ui-dpad" class="hidden">
            <div id="dpad-zone">
                <div></div><button class="d-btn" id="d-up">‚ñ≤</button><div></div>
                <button class="d-btn" id="d-left">‚óÄ</button><div></div><button class="d-btn" id="d-right">‚ñ∂</button>
                <div></div><button class="d-btn" id="d-down">‚ñº</button><div></div>
            </div>
            <button class="action-btn" id="btn-fire">FIRE</button>
        </div>

        <div id="ui-simple" class="hidden">
            <p id="simple-instr">TAP or TILT!</p>
            <button class="action-btn" id="btn-main" style="width: 200px; height: 200px;">ACTION</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, set, onValue, update, remove, onDisconnect } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        // --- 1. Firebase Setup ---
        const firebaseConfig = {
            apiKey: "AIzaSyDbZzTMvUkG2LXIGY4ux0KBTmnAdqP236s",
            authDomain: "game-4f2d9.firebaseapp.com",
            databaseURL: "https://game-4f2d9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "game-4f2d9",
            storageBucket: "game-4f2d9.firebasestorage.app",
            messagingSenderId: "574316347824",
            appId: "1:574316347824:web:cf686040628e25ad615675",
            measurementId: "G-T0ZKQCC9L3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // --- 2. Room & Role Logic ---
        const params = new URLSearchParams(window.location.search);
        let role = params.get('role') || 'host';
        let roomId = params.get('room');
        let myId = Math.random().toString(36).substr(2, 6);
        let currentMode = 'lobby';
        
        const PLAYER_COLORS = [0xff0000, 0x00ff00, 0x0000ff, 0xffff00, 0xff00ff, 0x00ffff];
        function getColor(id) {
            let hash = 0;
            for(let i=0; i<id.length; i++) hash = id.charCodeAt(i) + ((hash << 5) - hash);
            return PLAYER_COLORS[Math.abs(hash) % PLAYER_COLORS.length];
        }

        // --- KANJI DATA (Sample) ---
        // ÂÆüÈöõ„Å´„ÅØ1000Âïè„ÅÆÈÖçÂàó„ÇíÁî®ÊÑè„Åó„Åæ„Åô„Åå„ÄÅ„Åì„Åì„Åß„ÅØ„Çµ„É≥„Éó„É´„Å®„Åó„Å¶Â§öÊßò„Å™„Éë„Çø„Éº„É≥„ÇíÂÆöÁæ©„Åó„Åæ„Åô„ÄÇ
        const KANJI_DATA = [
            { q: "„ÄåÊÜÇÈ¨±„Äç„ÅÆË™≠„ÅøÊñπ„ÅØÔºü", opts: ["„ÇÜ„ÅÜ„ÅÜ„Å§", "„Åì„ÅÜ„Åã„Å§", "„ÅÇ„ÅÑ„Åæ„ÅÑ", "„Åë„Çì„Åä"], ans: 0 },
            { q: "„ÄåË∫äË∫á„Äç„ÅÆË™≠„ÅøÊñπ„ÅØÔºü", opts: ["„Åó„Çì„Å°„Çá", "„Å°„ÇÖ„ÅÜ„Å°„Çá", "„Åë„Çì„Å°„Çá", "„Å®„ÅÜ„Å°„Çá"], ans: 1 },
            { q: "„ÄåÁõ∏ÊÆ∫„Äç„ÅÆË™≠„ÅøÊñπ„ÅØÔºü", opts: ["„Åù„ÅÜ„Åï„Å§", "„ÅÇ„ÅÑ„Åï„ÅÑ", "„Åù„ÅÜ„Åï„ÅÑ", "„Åó„Çá„ÅÜ„Åï„Å§"], ans: 2 },
            { q: "„ÄåÂá°‰æã„Äç„ÅÆË™≠„ÅøÊñπ„ÅØÔºü", opts: ["„Åº„Çì„Çå„ÅÑ", "„ÅØ„Çì„Çå„ÅÑ", "„Å∏„ÅÑ„Çå„ÅÑ", "„Å§„Å≠„Çå„ÅÑ"], ans: 1 },
            { q: "„ÄåÂá∫ÁîüÁéá„Äç„ÅÆÊ≠£„Åó„ÅÑË™≠„Åø„ÅØÔºü", opts: ["„Åó„ÇÖ„Å£„Åó„Çá„ÅÜ„Çä„Å§", "„Åó„ÇÖ„Å£„Åõ„ÅÑ„Çä„Å§", "„Å©„Å°„Çâ„Åß„ÇÇ„Çà„ÅÑ", "„Åó„ÇÖ„Åó„Çá„ÅÜ„Çä„Å§"], ans: 2 },
            { q: "„ÄåË≤º‰ªò„Äç„ÅÆË™≠„ÅøÊñπ„ÅØÔºü", opts: ["„Å¶„Çì„Å∑", "„ÅØ„Å£„Å§„Åë", "„Å°„Çá„ÅÜ„Åµ", "„ÅØ„Çä„Å§„Åë"], ans: 2 },
            { q: "„ÄåÊó©ÊÄ•„Äç„ÅÆË™≠„ÅøÊñπ„ÅØÔºü", opts: ["„Åù„ÅÜ„Åç„ÇÖ„ÅÜ", "„Åï„Å£„Åç„ÇÖ„ÅÜ", "„ÅØ„ÇÑ„ÅÑ„Åù„Åé", "„Åï„Åç„ÇÖ„ÅÜ"], ans: 1 },
            { q: "„Äå‰∏ÄÊÑèÂ∞ÇÂøÉ„Äç„ÅÆÊÑèÂë≥„ÅØÔºü", opts: ["‰∏Ä„Å§„ÅÆ„Åì„Å®„Å´ÈõÜ‰∏≠„Åô„Çã", "‰∏Ä‰∫∫„ÅßÂøÉ„ÇíÊ±∫„ÇÅ„Çã", "ÊÑèÂë≥„Åå‰∏Ä„Å§„Åó„Åã„Å™„ÅÑ", "ÂøÉ„ÅåÂ§â„Çè„Çä„ÇÑ„Åô„ÅÑ"], ans: 0 },
            { q: "„Äå‰∫îÊúàÈõ®„Äç„ÅÆË™≠„ÅøÊñπ„ÅØÔºü", opts: ["„Åï„Å§„Åç„ÅÇ„ÇÅ", "„Åî„Åå„Å§„ÅÇ„ÇÅ", "„Åï„Åø„Å†„Çå", "„Å§„ÇÜ"], ans: 2 },
            { q: "„Äå‰ªñ‰∫∫‰∫ã„Äç„ÅÆÊ≠£„Åó„ÅÑË™≠„Åø„ÅØÔºü", opts: ["„Åü„Å´„Çì„Åî„Å®", "„Å≤„Å®„Åî„Å®", "„Çà„Åù„ÅÆ„Åì„Å®", "„Åü„Åò„Çì„Åò"], ans: 1 },
            { q: "„Äå‰æùÂ≠ò„Äç„ÅÆË™≠„ÅøÊñπ„ÅØÔºü", opts: ["„ÅÑ„Åû„Çì", "„ÅÑ„Åù„Çì", "„Å©„Å°„Çâ„Åß„ÇÇ„Çà„ÅÑ", "„Åà„Åù„Çì"], ans: 2 },
            { q: "„ÄåÈáçË§á„Äç„ÅÆÊÖ£Áî®ÁöÑ„Å™Ë™≠„Åø„ÅØÔºü", opts: ["„Åò„ÇÖ„ÅÜ„Åµ„Åè", "„Å°„Çá„ÅÜ„Åµ„Åè", "„Åò„Çá„ÅÜ„Åµ„Åè", "„Å°„ÇÖ„ÅÜ„Åµ„Åè"], ans: 1 },
            { q: "„ÄåÊº∏„Åè„Äç„ÅÆË™≠„ÅøÊñπ„ÅØÔºü", opts: ["„Åó„Å∞„Çâ„Åè", "„Çà„ÅÜ„ÇÑ„Åè", "„ÅÑ„Åü„Å†„Åè", "„Åì„Å®„Åî„Å®„Åè"], ans: 1 },
            { q: "„ÄåÂÅ•Ê∞ó„Äç„ÅÆË™≠„ÅøÊñπ„ÅØÔºü", opts: ["„Åë„Çì„Åí", "„Åô„Åì„ÇÑ„Åã", "„Åë„Å™„Åí", "„Åü„Åë„Åç"], ans: 2 },
            { q: "„ÄåÁæé‰∫∫Â±Ä„Äç„ÅÆË™≠„ÅøÊñπ„ÅØÔºü", opts: ["„Å≥„Åò„Çì„Åç„Çá„Åè", "„Å§„Å§„ÇÇ„Åü„Åõ", "„Å≥„Åò„Çì„Å§„Åº„Å≠", "„Éè„Éã„Éº„Éà„É©„ÉÉ„Éó"], ans: 1 },
            { q: "Ê¨°„ÅÆ„ÅÜ„Å°„Äå„Åä„Åò„Äç„Å®Ë™≠„ÇÄÊº¢Â≠ó„ÅØÔºü", opts: ["‰ºØÁà∂", "ÂèîÁà∂", "Â∞èÁà∂", "„Åô„Åπ„Å¶Ê≠£Ëß£"], ans: 3 },
            { q: "„ÄåËÑÜÂº±„Äç„ÅÆË™≠„ÅøÊñπ„ÅØÔºü", opts: ["„Åç„Åò„ÇÉ„Åè", "„Åú„ÅÑ„Åò„ÇÉ„Åè", "„Åç„Åò„Å£„Åè", "„Åù„ÅÜ„Åò„ÇÉ„Åè"], ans: 1 },
            { q: "„ÄåÁã¨Â£áÂ†¥„Äç„ÅÆÊú¨Êù•„ÅÆÊº¢Â≠ó„ÅØÔºü", opts: ["Áã¨ÊìÖÂ†¥", "Áã¨ÊÆµÂ†¥", "Áã¨Âõ£Â†¥", "Áã¨Êñ≠Â†¥"], ans: 0 },
            { q: "„ÄåÈÅµÂÆà„Äç„ÅÆË™≠„ÅøÊñπ„ÅØÔºü", opts: ["„Åù„Çì„Åó„ÇÖ", "„Åò„ÇÖ„Çì„Åó„ÇÖ", "„Åù„Çì„Åô", "„Å°„Çì„Åò„ÇÖ"], ans: 1 },
            { q: "„Äå‰ª£Êõø„Äç„ÅÆË™≠„ÅøÊñπ„ÅØÔºü", opts: ["„Å†„ÅÑ„Åå„Åà", "„Å†„ÅÑ„Åü„ÅÑ", "„Å†„ÅÑ„Åã„Åà", "„Å†„ÅÑ„Åç"], ans: 1 }
        ];

        // --- HOST LOGIC ---
        if (role === 'host') {
            if (!roomId) {
                roomId = Math.random().toString(36).substring(2, 6).toUpperCase();
                window.location.replace(`?role=host&room=${roomId}`);
            }
            
            document.getElementById('room-info').innerText = `ROOM: ${roomId}`;
            document.getElementById('host-lobby').classList.remove('hidden');

            const url = `${window.location.origin}${window.location.pathname}?role=ctrl&room=${roomId}`;
            new QRCode(document.getElementById("qrcode"), { text: url, width: 150, height: 150 });

            const playersRef = ref(db, `rooms/${roomId}/players`);
            let players = {};
            let gameLoopId = null;

            onValue(playersRef, (snap) => {
                players = snap.val() || {};
                updatePlayerList();
            });

            function updatePlayerList() {
                const list = Object.keys(players).map(k => `<span style="color:#${getColor(k).toString(16)}">‚óè ${players[k].name || 'Player ' + k.substr(0,3)}: ${players[k].score || 0}</span>`).join("  ");
                document.getElementById('player-list').innerHTML = `ÂèÇÂä†ËÄÖ: ${list}`;
                
                // Quiz Ranking Update
                if(currentMode === 'quiz') {
                    const sorted = Object.keys(players).sort((a,b) => (players[b].score||0) - (players[a].score||0));
                    document.getElementById('quiz-ranking').innerHTML = sorted.map((k, i) => 
                        `<div>${i+1}. Player ${k.substr(0,3)}: ${players[k].score||0}pt</div>`
                    ).join('');
                }
            }

            window.selectGame = (mode) => {
                currentMode = mode;
                update(ref(db, `rooms/${roomId}`), { mode: mode });
                
                // Reset UI
                ['host-lobby', 'host-3d', 'host-2d', 'host-quiz'].forEach(id => document.getElementById(id).classList.add('hidden'));

                if (gameLoopId) cancelAnimationFrame(gameLoopId);

                if (mode === 'flight3d') {
                    document.getElementById('host-3d').classList.remove('hidden');
                    init3DGame();
                } else if (mode === 'quiz') {
                    document.getElementById('host-quiz').classList.remove('hidden');
                    initQuizGame();
                } else {
                    document.getElementById('host-2d').classList.remove('hidden');
                    init2DGame(mode);
                }
            };

            window.backToLobby = () => {
                window.location.reload();
            };

            // --- QUIZ LOGIC ---
            function initQuizGame() {
                // Initialize Scores
                Object.keys(players).forEach(id => update(ref(db, `rooms/${roomId}/players/${id}`), { score: 0, answer: null }));
                
                let qIndex = -1;
                let phase = 'ready'; // ready, question, result
                let timeLeft = 0;
                let currentQ = null;

                const nextQuestion = () => {
                    qIndex++;
                    if (qIndex >= KANJI_DATA.length) qIndex = 0; // Loop questions
                    currentQ = KANJI_DATA[qIndex];
                    
                    // Update Display
                    document.getElementById('quiz-status').innerText = `Á¨¨ ${qIndex + 1} Âïè`;
                    document.getElementById('q-text').innerText = currentQ.q;
                    currentQ.opts.forEach((o, i) => {
                        const el = document.getElementById(`opt-${i}`);
                        el.innerText = ["A", "B", "C", "D"][i] + ": " + o;
                        el.classList.remove('correct');
                        el.style.opacity = 1;
                    });
                    
                    // Reset Answers in DB
                    Object.keys(players).forEach(id => update(ref(db, `rooms/${roomId}/players/${id}`), { answer: null }));

                    // Start Phase
                    phase = 'question';
                    timeLeft = 10; // 10 seconds
                    
                    // Sync to clients
                    update(ref(db, `rooms/${roomId}/quiz`), { phase: 'question' });

                    const timer = setInterval(() => {
                        timeLeft -= 0.1;
                        document.getElementById('q-bar').style.width = `${(timeLeft/10)*100}%`;
                        
                        if (timeLeft <= 0) {
                            clearInterval(timer);
                            showResult();
                        }
                    }, 100);
                };

                const showResult = () => {
                    phase = 'result';
                    document.getElementById('quiz-status').innerText = "Ê≠£Ëß£Áô∫Ë°®ÔºÅ";
                    update(ref(db, `rooms/${roomId}/quiz`), { phase: 'result', correct: currentQ.ans });

                    // Highlight correct answer
                    document.getElementById(`opt-${currentQ.ans}`).classList.add('correct');
                    [0,1,2,3].forEach(i => {
                        if(i !== currentQ.ans) document.getElementById(`opt-${i}`).style.opacity = 0.3;
                    });

                    // Calculate Scores
                    Object.keys(players).forEach(id => {
                        const p = players[id];
                        if (p.answer === currentQ.ans) {
                            const newScore = (p.score || 0) + 10;
                            update(ref(db, `rooms/${roomId}/players/${id}`), { score: newScore });
                        }
                    });

                    setTimeout(nextQuestion, 5000); // Next question in 5s
                };

                setTimeout(nextQuestion, 2000);
            }

            // --- 3D ENGINE (Simplified for space) ---
            let scene, camera, renderer, planes = {};
            function init3DGame() {
                const container = document.getElementById('game-container-3d');
                scene = new THREE.Scene();
                scene.background = new THREE.Color(0x87CEEB);
                scene.fog = new THREE.Fog(0x87CEEB, 10, 500);
                camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
                camera.position.set(0, 50, 100); camera.lookAt(0,0,0);
                renderer = new THREE.WebGLRenderer({ antialias: true });
                renderer.setSize(window.innerWidth, window.innerHeight);
                container.innerHTML = ''; container.appendChild(renderer.domElement);
                scene.add(new THREE.DirectionalLight(0xffffff, 1));
                scene.add(new THREE.GridHelper(1000, 100, 0x555555, 0xcccccc));
                animate3D();
            }
            function animate3D() {
                if (currentMode !== 'flight3d') return;
                gameLoopId = requestAnimationFrame(animate3D);
                Object.keys(players).forEach(id => {
                    if (!planes[id]) {
                        const g = new THREE.Group();
                        const m = new THREE.Mesh(new THREE.ConeGeometry(2,8,8), new THREE.MeshBasicMaterial({color: getColor(id)}));
                        m.rotation.x = Math.PI/2; g.add(m); scene.add(g);
                        planes[id] = {mesh: g};
                    }
                    const p = players[id];
                    if (p.input) {
                        planes[id].mesh.rotation.z -= p.input.x * 0.05;
                        planes[id].mesh.rotation.x += p.input.y * 0.05;
                        planes[id].mesh.translateY(p.action ? 1.5 : 0.8);
                    }
                });
                renderer.render(scene, camera);
            }

            // --- 2D ENGINE (Simplified) ---
            let ctx, canvas;
            function init2DGame(mode) {
                canvas = document.getElementById('canvas-2d');
                ctx = canvas.getContext('2d');
                canvas.width = window.innerWidth; canvas.height = window.innerHeight;
                animate2D(mode);
            }
            function animate2D(mode) {
                if (currentMode !== mode) return;
                gameLoopId = requestAnimationFrame(() => animate2D(mode));
                ctx.fillStyle = '#222'; ctx.fillRect(0, 0, canvas.width, canvas.height);
                Object.keys(players).forEach((id, idx) => {
                    const p = players[id];
                    if(!p.x) { p.x = 100 + idx*50; p.y = 100; }
                    ctx.fillStyle = '#' + getColor(id).toString(16).padStart(6, '0');
                    if(mode === 'shooter2d' && p.input) {
                        if(p.input.u) p.y-=3; if(p.input.d) p.y+=3; if(p.input.l) p.x-=3; if(p.input.r) p.x+=3;
                        ctx.beginPath(); ctx.arc(p.x, p.y, 20, 0, Math.PI*2); ctx.fill();
                    }
                    else if(mode === 'sniper') {
                         if(p.gyro) { p.x = canvas.width/2 + p.gyro.gamma*10; p.y = canvas.height/2 + p.gyro.beta*10; }
                         ctx.strokeStyle = ctx.fillStyle; ctx.lineWidth=2;
                         ctx.strokeRect(p.x-20, p.y-20, 40, 40);
                    }
                    else { // Race/Sumo/Paint
                        if(p.action) { p.x += 5; p.action = false; }
                        ctx.fillRect(p.x, 50 + idx * 60, 40, 40);
                    }
                });
            }
        }

        // --- CONTROLLER LOGIC ---
        else {
            document.getElementById('controller-view').classList.remove('hidden');
            const myRef = ref(db, `rooms/${roomId}/players/${myId}`);
            onDisconnect(myRef).remove();

            // Sync Game Mode
            onValue(ref(db, `rooms/${roomId}/mode`), (snap) => {
                const mode = snap.val() || 'lobby';
                setupUI(mode);
            });
            
            // Sync Quiz State
            let quizPhase = 'question';
            onValue(ref(db, `rooms/${roomId}/quiz`), (snap) => {
                const val = snap.val();
                if(!val) return;
                
                if (val.phase === 'question') {
                    document.getElementById('quiz-feedback').innerText = "ÂõûÁ≠îÂèó‰ªò‰∏≠";
                    document.getElementById('controller-view').style.backgroundColor = '#222';
                    enableQuizButtons(true);
                } else if (val.phase === 'result') {
                    enableQuizButtons(false);
                    // Check if I was correct (locally stored or fetched)
                    // For simplicity, we just show "Answer Revealed" here.
                    // Real feedback would check my last sent answer vs val.correct
                }
            });

            window.sendAnswer = (ansIndex) => {
                update(myRef, { answer: ansIndex });
                document.getElementById('quiz-feedback').innerText = ["A", "B", "C", "D"][ansIndex] + " „ÇíÈÅ∏Êäû";
                // Vibrate
                if(navigator.vibrate) navigator.vibrate(50);
            };

            function enableQuizButtons(enable) {
                const btns = document.querySelectorAll('.q-btn');
                btns.forEach(b => {
                    b.disabled = !enable;
                    b.style.opacity = enable ? 1 : 0.5;
                });
            }

            function setupUI(mode) {
                ['ui-joystick', 'ui-dpad', 'ui-simple', 'ui-quiz'].forEach(id => document.getElementById(id).classList.add('hidden'));
                document.getElementById('ctrl-title').innerText = mode.toUpperCase();

                if (mode === 'flight3d') {
                    document.getElementById('ui-joystick').classList.remove('hidden');
                    startJoystick();
                } else if (mode === 'shooter2d') {
                    document.getElementById('ui-dpad').classList.remove('hidden');
                } else if (mode === 'quiz') {
                    document.getElementById('ui-quiz').classList.remove('hidden');
                } else if (['sumo', 'race', 'paint'].includes(mode)) {
                    document.getElementById('ui-simple').classList.remove('hidden');
                    document.getElementById('simple-instr').innerText = "TAP FAST!";
                } else if (mode === 'sniper') {
                    document.getElementById('ui-simple').classList.remove('hidden');
                    document.getElementById('simple-instr').innerText = "TILT TO AIM";
                    startGyro();
                }
            }

            // Input Handlers (Condensed)
            function startJoystick() {
                const z = document.getElementById('joystick-zone'), k = document.getElementById('joystick-knob');
                let sx, sy;
                z.ontouchstart = e => { e.preventDefault(); sx=e.touches[0].clientX; sy=e.touches[0].clientY; };
                z.ontouchmove = e => {
                    e.preventDefault();
                    let dx=e.touches[0].clientX-sx, dy=e.touches[0].clientY-sy, d=Math.sqrt(dx*dx+dy*dy);
                    if(d>70) { dx=(dx/d)*70; dy=(dy/d)*70; }
                    k.style.transform=`translate(calc(-50% + ${dx}px),calc(-50% + ${dy}px))`;
                    update(myRef, {input:{x:dx/70, y:dy/70}});
                };
                z.ontouchend = () => { k.style.transform=`translate(-50%,-50%)`; update(myRef,{input:{x:0,y:0}}); };
                document.getElementById('btn-boost').ontouchstart = e => { e.preventDefault(); update(myRef,{action:true}); };
                document.getElementById('btn-boost').ontouchend = e => { e.preventDefault(); update(myRef,{action:false}); };
            }
            
            ['up','down','left','right'].forEach(d => {
                const b = document.getElementById(`d-${d}`);
                b.ontouchstart = e => { e.preventDefault(); update(myRef, {input:{[d[0]]:1}}); };
                b.ontouchend = e => { e.preventDefault(); update(myRef, {input:{[d[0]]:0}}); };
            });
            document.getElementById('btn-fire').ontouchstart = e => { e.preventDefault(); update(myRef,{action:true}); };
            document.getElementById('btn-fire').ontouchend = e => { e.preventDefault(); update(myRef,{action:false}); };

            document.getElementById('btn-main').ontouchstart = e => {
                e.preventDefault(); update(myRef, {action:true});
                setTimeout(()=>update(myRef,{action:false}),100);
            };

            function startGyro() {
                if(typeof DeviceOrientationEvent.requestPermission === 'function') {
                    const btn = document.getElementById('btn-main');
                    btn.innerText = "TAP TO SYNC";
                    btn.onclick = async () => { await DeviceOrientationEvent.requestPermission(); bindGyro(); btn.innerText="FIRE"; };
                } else bindGyro();
            }
            function bindGyro() {
                let last=0; window.ondeviceorientation = e => {
                    if(Date.now()-last>50) { update(myRef, {gyro:{beta:e.beta, gamma:e.gamma}}); last=Date.now(); }
                };
            }
        }
    </script>
</body>
</html>
