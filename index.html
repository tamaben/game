<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>QR連携スマホリモコン</title>
    <!-- QRコード生成ライブラリ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body { font-family: 'Hiragino Kaku Gothic ProN', sans-serif; margin: 0; background: #121212; color: white; overflow: hidden; touch-action: none; }
        .hidden { display: none !important; }
        .flex-center { display: flex; flex-direction: column; align-items: center; justify-content: center; height: 100vh; text-align: center; }
        
        /* ホスト画面（PC） */
        #qrcode-container { background: white; padding: 20px; border-radius: 10px; margin-top: 20px; }
        canvas { border: 2px solid #444; background: #000; box-shadow: 0 0 30px rgba(0,255,255,0.2); max-width: 90vw; }
        .room-id { font-size: 24px; color: #00d4ff; margin-bottom: 10px; font-weight: bold; }

        /* コントローラー画面（スマホ） */
        #controller-view { background: linear-gradient(135deg, #1e3a8a 0%, #1e1b4b 100%); }
        .action-btn { width: 200px; height: 200px; border-radius: 50%; border: none; background: #ef4444; color: white; font-size: 28px; font-weight: bold; box-shadow: 0 10px #b91c1c; active: translateY(5px); }
        .action-btn:active { transform: translateY(5px); box-shadow: 0 5px #b91c1c; }
        #start-btn { padding: 20px 50px; font-size: 22px; background: #10b981; color: white; border: none; border-radius: 50px; cursor: pointer; }
        
        #debug-log { position: fixed; bottom: 5px; width: 100%; font-size: 10px; color: #666; pointer-events: none; }
    </style>
</head>
<body>

    <!-- PC：ホスト待機画面 -->
    <div id="host-setup" class="flex-center hidden">
        <h1>スマホを接続してください</h1>
        <p>下のQRコードをカメラでスキャン！</p>
        <div id="qrcode-container">
            <div id="qrcode"></div>
        </div>
        <p class="room-id" id="display-room-id"></p>
    </div>

    <!-- PC：メインゲーム画面 -->
    <div id="host-game" class="flex-center hidden">
        <canvas id="gameCanvas" width="800" height="500"></canvas>
        <p>スマホを傾けて移動 / 振ってチャージ / タップで爆発</p>
    </div>

    <!-- スマホ：コントローラー画面 -->
    <div id="controller-view" class="flex-center hidden">
        <div id="controller-setup">
            <h2>CONTROLLER</h2>
            <p>Ready?</p>
            <button id="start-btn">接続開始</button>
        </div>
        <div id="controller-active" class="hidden">
            <p id="charge-text">振ってエネルギーを溜めろ！</p>
            <div style="width: 250px; height: 20px; background: #333; margin: 20px auto; border-radius: 10px; overflow: hidden;">
                <div id="charge-bar" style="width: 0%; height: 100%; background: #fbbf24; transition: width 0.1s;"></div>
            </div>
            <button id="action-btn" class="action-btn">ATTACK</button>
        </div>
    </div>

    <div id="debug-log"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, set, onValue } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        // Firebase設定
        const firebaseConfig = {
            apiKey: "AIzaSyDbZzTMvUkG2LXIGY4ux0KBTmnAdqP236s",
            authDomain: "game-4f2d9.firebaseapp.com",
            databaseURL: "https://game-4f2d9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "game-4f2d9",
            storageBucket: "game-4f2d9.firebasestorage.app",
            messagingSenderId: "574316347824",
            appId: "1:574316347824:web:cf686040628e25ad615675",
            measurementId: "G-T0ZKQCC9L3"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);

        // URLパラメータから情報を取得
        const urlParams = new URLSearchParams(window.location.search);
        let role = urlParams.get('role') || 'host';
        let roomId = urlParams.get('room');

        // --- ホスト側の初期化 ---
        if (role === 'host') {
            // Room IDがなければ生成してリダイレクト
            if (!roomId) {
                roomId = Math.random().toString(36).substring(2, 7).toUpperCase();
                window.location.href = window.location.origin + window.location.pathname + `?role=host&room=${roomId}`;
            }

            document.getElementById('host-setup').classList.remove('hidden');
            document.getElementById('display-room-id').innerText = "ROOM ID: " + roomId;

            // スマホ用URLの生成 (このHTML自体をコントローラーモードで開かせる)
            const controllerUrl = window.location.origin + window.location.pathname + `?role=controller&room=${roomId}`;
            
            // QRコード生成
            new QRCode(document.getElementById("qrcode"), {
                text: controllerUrl,
                width: 200,
                height: 200
            });

            const gameRef = ref(db, 'rooms/' + roomId);
            let gameStarted = false;

            // ゲーム状態
            let state = { x: 400, y: 250, charge: 0, particles: [] };

            // Firebaseのデータ受信
            onValue(gameRef, (snapshot) => {
                const data = snapshot.val();
                if (!data) return;

                // 最初の信号を受け取ったらゲーム画面に切り替え
                if (!gameStarted) {
                    gameStarted = true;
                    document.getElementById('host-setup').classList.add('hidden');
                    document.getElementById('host-game').classList.remove('hidden');
                    startHeartbeat();
                }

                if (data.type === 'move') {
                    state.x += data.gamma * 0.6;
                    state.y += data.beta * 0.6;
                } else if (data.type === 'shake') {
                    state.charge = Math.min(state.charge + 2, 100);
                } else if (data.type === 'attack') {
                    explode(state.x, state.y, state.charge);
                    state.charge = 0;
                }
                
                state.x = Math.max(0, Math.min(800, state.x));
                state.y = Math.max(0, Math.min(500, state.y));
            });

            // ゲーム描画処理
            const canvas = document.getElementById('gameCanvas');
            const ctx = canvas.getContext('2d');

            function explode(x, y, power) {
                for(let i=0; i < power + 10; i++) {
                    state.particles.push({
                        x, y, 
                        vx: (Math.random()-0.5)*15, 
                        vy: (Math.random()-0.5)*15, 
                        life: 1.0,
                        color: `hsl(${Math.random()*360}, 100%, 50%)`
                    });
                }
            }

            function draw() {
                ctx.fillStyle = 'rgba(0, 0, 0, 0.15)';
                ctx.fillRect(0, 0, canvas.width, canvas.height);

                // 自機
                const glow = 10 + state.charge / 2;
                ctx.shadowBlur = glow;
                ctx.shadowColor = "#00d4ff";
                ctx.fillStyle = "#00d4ff";
                ctx.beginPath();
                ctx.arc(state.x, state.y, 15 + state.charge/5, 0, Math.PI*2);
                ctx.fill();
                ctx.shadowBlur = 0;

                // エフェクト
                state.particles.forEach((p, i) => {
                    p.x += p.vx; p.y += p.vy; p.life -= 0.02;
                    ctx.fillStyle = p.color;
                    ctx.globalAlpha = p.life;
                    ctx.fillRect(p.x, p.y, 5, 5);
                    if(p.life <= 0) state.particles.splice(i, 1);
                });
                ctx.globalAlpha = 1;

                requestAnimationFrame(draw);
            }
            draw();

            // 接続維持用のダミー書き込み
            function startHeartbeat() {
                setInterval(() => set(ref(db, 'rooms/' + roomId + '/heartbeat'), Date.now()), 5000);
            }
        }

        // --- コントローラー（スマホ）側の初期化 ---
        else {
            document.getElementById('controller-view').classList.remove('hidden');
            const startBtn = document.getElementById('start-btn');
            const gameRef = ref(db, 'rooms/' + roomId);

            startBtn.addEventListener('click', async () => {
                // センサー許可リクエスト
                if (typeof DeviceMotionEvent.requestPermission === 'function') {
                    const res = await DeviceMotionEvent.requestPermission();
                    if (res !== 'granted') return alert("センサーを許可してください");
                }
                
                document.getElementById('controller-setup').classList.add('hidden');
                document.getElementById('controller-active').classList.remove('hidden');

                // 1. 傾き検知 (ジャイロ)
                let lastSend = 0;
                window.addEventListener('deviceorientation', (e) => {
                    const now = Date.now();
                    if (now - lastSend > 80) { // 負荷軽減のため80ms間隔
                        set(gameRef, { type: 'move', beta: e.beta, gamma: e.gamma });
                        lastSend = now;
                    }
                });

                // 2. 攻撃ボタン (タップ)
                const actionBtn = document.getElementById('action-btn');
                let charge = 0;
                actionBtn.addEventListener('touchstart', (e) => {
                    e.preventDefault();
                    set(gameRef, { type: 'attack' });
                    charge = 0;
                    document.getElementById('charge-bar').style.width = '0%';
                    if(navigator.vibrate) navigator.vibrate(100);
                });

                // 3. シェイク検知 (加速度)
                let lastX=0, lastY=0;
                window.addEventListener('devicemotion', (e) => {
                    const acc = e.accelerationIncludingGravity;
                    if(!acc) return;
                    let move = Math.abs(acc.x - lastX) + Math.abs(acc.y - lastY);
                    if(move > 25) {
                        charge = Math.min(charge + 5, 100);
                        document.getElementById('charge-bar').style.width = charge + '%';
                        set(gameRef, { type: 'shake' });
                        if(navigator.vibrate) navigator.vibrate(20);
                    }
                    lastX = acc.x; lastY = acc.y;
                });
            });
        }
    </script>
</body>
</html>
