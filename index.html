<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>GAKU-QUIZ BATTLE</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+JP:wght@400;700;900&display=swap" rel="stylesheet">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/canvas-confetti/1.6.0/confetti.browser.min.js"></script>
    
    <style>
        :root {
            --bg-color: #e0e5ec;
            --shadow-light: #ffffff;
            --shadow-dark: #a3b1c6;
            --primary: #4d79ff;
            --danger: #ff4d4d;
            --success: #00b894;
            --text-main: #4a4a4a;
        }

        body {
            font-family: 'Noto Sans JP', sans-serif;
            background-color: var(--bg-color);
            color: var(--text-main);
            margin: 0;
            overflow: hidden;
            user-select: none;
        }

        .hidden { display: none !important; }
        .full-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
        }

        /* --- Neumorphism UI --- */
        .neu-box {
            background: var(--bg-color);
            border-radius: 20px;
            box-shadow: 9px 9px 16px var(--shadow-dark), -9px -9px 16px var(--shadow-light);
            padding: 30px;
            text-align: center;
        }

        .neu-btn {
            border: none;
            outline: none;
            background: var(--bg-color);
            border-radius: 15px;
            box-shadow: 6px 6px 10px var(--shadow-dark), -6px -6px 10px var(--shadow-light);
            color: var(--primary);
            font-weight: bold;
            padding: 15px 30px;
            margin: 10px;
            font-size: 1.2rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .neu-btn:active, .neu-btn.active {
            box-shadow: inset 6px 6px 10px var(--shadow-dark), inset -6px -6px 10px var(--shadow-light);
            transform: translateY(2px);
        }

        .neu-input {
            border: none;
            background: var(--bg-color);
            border-radius: 10px;
            box-shadow: inset 6px 6px 10px var(--shadow-dark), inset -6px -6px 10px var(--shadow-light);
            padding: 15px;
            font-size: 1.2rem;
            text-align: center;
            width: 80%;
            margin-bottom: 20px;
            color: var(--text-main);
        }

        /* --- HOST SCREENS --- */
        #host-lobby h1 { font-size: 3rem; color: var(--primary); text-shadow: 2px 2px 4px rgba(0,0,0,0.1); }
        .subject-grid { display: grid; grid-template-columns: repeat(3, 1fr); gap: 20px; margin-top: 20px; max-height: 50vh; overflow-y: auto; }
        .subject-card { cursor: pointer; height: 100px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; }
        
        #game-screen { width: 90%; max-width: 1000px; }
        #timer-bar-container {
            width: 100%; height: 20px; border-radius: 10px;
            box-shadow: inset 6px 6px 10px var(--shadow-dark), inset -6px -6px 10px var(--shadow-light);
            margin-bottom: 20px; overflow: hidden; position: relative;
        }
        #timer-bar {
            height: 100%; width: 100%; background: linear-gradient(90deg, #4d79ff, #00b894);
            border-radius: 10px; transition: width 0.1s linear;
        }

        #question-text { font-size: 2.5rem; font-weight: 900; margin: 30px 0; min-height: 100px; line-height: 1.4; }
        
        .answer-display { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; width: 100%; }
        .ans-option { 
            padding: 20px; font-size: 1.5rem; border-radius: 15px; 
            box-shadow: 6px 6px 10px var(--shadow-dark), -6px -6px 10px var(--shadow-light);
            opacity: 0.8;
            display: flex; align-items: center; justify-content: center;
        }
        .ans-option.correct { background-color: var(--success); color: white; opacity: 1; transform: scale(1.05); }
        .ans-option.dim { opacity: 0.3; }

        /* --- CONTROLLER SCREENS --- */
        #controller-view { background: #333; color: white; }
        .ctl-btn { 
            width: 100%; height: 100px; margin-bottom: 20px; border-radius: 15px; border: none; 
            font-size: 2rem; font-weight: bold; color: white;
            box-shadow: 0 4px 10px rgba(0,0,0,0.5);
        }
        .ctl-btn:active { transform: scale(0.95); }
        
        .c-red { background: #ff5252; } .c-blue { background: #448aff; }
        .c-green { background: #69f0ae; color: #333; } .c-yellow { background: #ffd740; color: #333; }

        /* --- RESULT --- */
        .ranking-item { 
            display: flex; justify-content: space-between; padding: 15px; 
            border-bottom: 1px solid rgba(0,0,0,0.1); font-size: 1.5rem; 
        }
        .ranking-item:nth-child(1) { color: #d4af37; font-weight: bold; font-size: 2rem; }
    </style>
</head>
<body>

    <div id="room-info" style="position:fixed; top:10px; left:10px; opacity:0.5; font-size:12px;">Connecting...</div>

    <div id="loading-screen" class="full-screen" style="z-index: 999; background: var(--bg-color);">
        <h2>Ë™≠„ÅøËæº„Åø‰∏≠...</h2>
    </div>

    <div id="host-lobby" class="full-screen hidden">
        <div class="neu-box">
            <h1>GAKU-QUIZ</h1>
            <div style="display:flex; justify-content:center; gap:30px; align-items:center;">
                <div id="qrcode" style="padding:10px; background:white; border-radius:10px;"></div>
                <div style="text-align:left;">
                    <p style="font-size:1.2rem;">„Çπ„Éû„Éõ„ÅßÂèÇÂä†„Åó„Å¶„Å≠ÔºÅ</p>
                    <h2 id="player-count">ÂèÇÂä†ËÄÖ: 0‰∫∫</h2>
                </div>
            </div>
            
            <h3 style="margin-top:30px;">ÊïôÁßë„ÇíÈÅ∏Êäû„Åó„Å¶„Çπ„Çø„Éº„Éà</h3>
            <div class="subject-grid" id="subject-selector">
                </div>
        </div>
    </div>

    <div id="host-game" class="full-screen hidden">
        <div id="game-screen" class="neu-box">
            <h2 id="current-subject" style="color:var(--primary); margin:0;">ÊïôÁßëÂêç</h2>
            <div id="question-counter" style="color:#888;">Á¨¨ 1 Âïè</div>
            
            <div id="question-text">ÂïèÈ°åÊñá</div>
            
            <div id="timer-bar-container">
                <div id="timer-bar"></div>
            </div>

            <div class="answer-display">
                <div class="ans-option" id="opt-0">A</div>
                <div class="ans-option" id="opt-1">B</div>
                <div class="ans-option" id="opt-2">C</div>
                <div class="ans-option" id="opt-3">D</div>
            </div>
        </div>
    </div>

    <div id="host-result" class="full-screen hidden">
        <div class="neu-box" style="min-width: 500px;">
            <h1 id="result-title">ÁµêÊûúÁô∫Ë°®</h1>
            <div id="ranking-list" style="text-align:left; max-height: 400px; overflow-y:auto;">
                </div>
            <button class="neu-btn" onclick="location.reload()">„Çø„Ç§„Éà„É´„Å∏Êàª„Çã</button>
        </div>
    </div>

    <div id="ctrl-login" class="full-screen hidden" style="background:var(--bg-color);">
        <div class="neu-box">
            <h2>ÂêçÂâç„ÇíÂÖ•„Çå„Å¶„Å≠</h2>
            <input type="text" id="p-name" class="neu-input" placeholder="„Éã„ÉÉ„ÇØ„Éç„Éº„É†" maxlength="8">
            <br>
            <button class="neu-btn" onclick="joinGame()">ÂèÇÂä†„Åô„Çã</button>
        </div>
    </div>

    <div id="ctrl-wait" class="full-screen hidden" style="background:#222; color:white;">
        <h2>WAITING...</h2>
        <p>„Éõ„Çπ„Éà„ÅåÊïôÁßë„ÇíÈÅ∏„Çì„Åß„ÅÑ„Åæ„Åô</p>
    </div>

    <div id="ctrl-buttons" class="full-screen hidden">
        <div style="display:grid; grid-template-columns:1fr 1fr; gap:15px; width:90%; height:90%;">
            <button class="ctl-btn c-red" onclick="sendAns(0)">A</button>
            <button class="ctl-btn c-blue" onclick="sendAns(1)">B</button>
            <button class="ctl-btn c-yellow" onclick="sendAns(2)">C</button>
            <button class="ctl-btn c-green" onclick="sendAns(3)">D</button>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
        import { getDatabase, ref, update, onValue, onDisconnect, set, remove } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

        const firebaseConfig = {
            apiKey: "AIzaSyDbZzTMvUkG2LXIGY4ux0KBTmnAdqP236s",
            authDomain: "game-4f2d9.firebaseapp.com",
            databaseURL: "https://game-4f2d9-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "game-4f2d9"
        };

        const app = initializeApp(firebaseConfig);
        const db = getDatabase(app);
        
        // --- GLOBAL VARIABLES ---
        let QUIZ_DATABASE = null;
        
        const params = new URLSearchParams(window.location.search);
        let role = params.get('role');
        let roomId = params.get('room');
        const myId = Math.random().toString(36).substr(2, 6);
        let currentSubject = null;
        let qList = [];
        let qIndex = 0;
        let timerId = null;

        // --- FETCH DATA ---
        async function loadQuizData() {
            try {
                const response = await fetch('quiz_data.json');
                if (!response.ok) throw new Error("File not found");
                QUIZ_DATABASE = await response.json();
                document.getElementById('loading-screen').classList.add('hidden');
                
                // Start Logic
                if (!role) {
                    roomId = Math.random().toString(36).substring(2, 6).toUpperCase();
                    window.location.replace(`?role=host&room=${roomId}`);
                } else if (role === 'host') {
                    initHost();
                } else {
                    initClient();
                }
            } catch (error) {
                alert("„Ç®„É©„ÉºÔºöquiz_data.json„ÇíË™≠„ÅøËæº„ÇÅ„Åæ„Åõ„Çì„Åß„Åó„Åü„ÄÇ\n‚ÄªPC„ÅßÂãï„Åã„ÅôÂ†¥Âêà„ÅØVS Code„ÅÆLive Server„Å™„Å©„Çí‰Ωø„Å£„Å¶„Åè„Å†„Åï„ÅÑ„ÄÇ");
                console.error(error);
            }
        }

        // Start Loading
        loadQuizData();

        // =======================
        //      HOST LOGIC
        // =======================
        function initHost() {
            document.getElementById('host-lobby').classList.remove('hidden');
            document.getElementById('room-info').innerText = `ID: ${roomId}`;

            const url = `${window.location.origin}${window.location.pathname}?role=ctrl&room=${roomId}`;
            new QRCode(document.getElementById("qrcode"), { text: url, width: 120, height: 120 });

            update(ref(db, `rooms/${roomId}`), { status: 'lobby', qIndex: -1 });
            remove(ref(db, `rooms/${roomId}/players`));

            const selector = document.getElementById('subject-selector');
            selector.innerHTML = '';
            
            // Generate Buttons from JSON
            if(QUIZ_DATABASE) {
                Object.keys(QUIZ_DATABASE).forEach(key => {
                    const sub = QUIZ_DATABASE[key];
                    const div = document.createElement('div');
                    div.className = 'neu-btn subject-card';
                    div.innerText = sub.name;
                    div.onclick = () => startSubject(key);
                    selector.appendChild(div);
                });
            }

            onValue(ref(db, `rooms/${roomId}/players`), (snap) => {
                const players = snap.val() || {};
                document.getElementById('player-count').innerText = `ÂèÇÂä†ËÄÖ: ${Object.keys(players).length}‰∫∫`;
            });
        }

        function startSubject(key) {
            currentSubject = QUIZ_DATABASE[key];
            qList = currentSubject.questions;
            qIndex = 0;
            
            document.getElementById('host-lobby').classList.add('hidden');
            document.getElementById('host-game').classList.remove('hidden');
            document.getElementById('current-subject').innerText = currentSubject.name;
            
            runQuestion();
        }

        function runQuestion() {
            if (qIndex >= qList.length) {
                endGame();
                return;
            }

            const q = qList[qIndex];
            document.getElementById('question-counter').innerText = `Á¨¨ ${qIndex + 1} / ${qList.length} Âïè`;
            document.getElementById('question-text').innerText = q.q;
            
            q.opts.forEach((txt, i) => {
                const el = document.getElementById(`opt-${i}`);
                el.innerText = txt;
                el.className = 'ans-option';
            });

            update(ref(db, `rooms/${roomId}`), {
                status: 'question',
                startTime: Date.now(),
                limit: q.time,
                qIndex: qIndex
            });

            let timeLeft = q.time;
            const bar = document.getElementById('timer-bar');
            bar.style.width = '100%';
            bar.style.background = 'linear-gradient(90deg, #4d79ff, #00b894)';

            clearInterval(timerId);
            timerId = setInterval(() => {
                timeLeft -= 0.1;
                const pct = (timeLeft / q.time) * 100;
                bar.style.width = `${pct}%`;

                if (timeLeft <= 3) bar.style.background = '#ff4d4d';

                if (timeLeft <= 0) {
                    clearInterval(timerId);
                    showAnswer();
                }
            }, 100);
        }

        function showAnswer() {
            const q = qList[qIndex];
            const correctIdx = q.ans;
            
            document.getElementById(`opt-${correctIdx}`).classList.add('correct');
            [0,1,2,3].forEach(i => {
                if (i !== correctIdx) document.getElementById(`opt-${i}`).classList.add('dim');
            });

            update(ref(db, `rooms/${roomId}`), { status: 'result' });

            setTimeout(() => {
                gradeAndNext();
            }, 4000); // 4ÁßíÂæå„Å´Ê¨°„Å∏
        }

        function gradeAndNext() {
            onValue(ref(db, `rooms/${roomId}/players`), (snap) => {
                const players = snap.val() || {};
                const q = qList[qIndex];
                const updates = {};

                Object.keys(players).forEach(pid => {
                    const p = players[pid];
                    let currentScore = p.score || 0;
                    if (p.lastAns === q.ans) {
                        currentScore += 10;
                    }
                    updates[`${pid}/score`] = currentScore;
                    updates[`${pid}/lastAns`] = null;
                });
                
                update(ref(db, `rooms/${roomId}/players`), updates).then(() => {
                    qIndex++;
                    runQuestion();
                });
            }, { onlyOnce: true });
        }

        function endGame() {
            document.getElementById('host-game').classList.add('hidden');
            document.getElementById('host-result').classList.remove('hidden');
            
            update(ref(db, `rooms/${roomId}`), { status: 'finish' });
            
            confetti({ particleCount: 150, spread: 70, origin: { y: 0.6 } });

            onValue(ref(db, `rooms/${roomId}/players`), (snap) => {
                const players = snap.val() || {};
                const sorted = Object.values(players).sort((a,b) => b.score - a.score);
                
                const list = document.getElementById('ranking-list');
                list.innerHTML = '';
                
                sorted.forEach((p, i) => {
                    const div = document.createElement('div');
                    div.className = 'ranking-item';
                    
                    let icon = '';
                    if (i === 0) icon = 'üëë ';
                    else if (i === 1) icon = 'ü•à ';
                    else if (i === 2) icon = 'ü•â ';

                    div.innerHTML = `<span>${icon}${i+1}. ${p.name}</span> <span>${p.score}pt</span>`;
                    list.appendChild(div);
                });
            });
        }

        // =======================
        //      CLIENT LOGIC
        // =======================
        function initClient() {
            document.getElementById('ctrl-login').classList.remove('hidden');
        }

        window.joinGame = () => {
            const name = document.getElementById('p-name').value || "ÂêçÁÑ°„Åó";
            const myRef = ref(db, `rooms/${roomId}/players/${myId}`);
            
            set(myRef, {
                name: name,
                score: 0,
                lastAns: null
            });
            onDisconnect(myRef).remove();

            document.getElementById('ctrl-login').classList.add('hidden');
            document.getElementById('ctrl-wait').classList.remove('hidden');

            onValue(ref(db, `rooms/${roomId}`), (snap) => {
                const state = snap.val();
                if (!state) return;

                if (state.status === 'lobby') {
                    showScreen('ctrl-wait');
                } else if (state.status === 'question') {
                    showScreen('ctrl-buttons');
                    enableButtons(true);
                } else if (state.status === 'result') {
                    enableButtons(false);
                } else if (state.status === 'finish') {
                    showScreen('ctrl-wait');
                    document.querySelector('#ctrl-wait h2').innerText = "ÁµÇ‰∫ÜÔºÅ";
                    document.querySelector('#ctrl-wait p').innerText = "ÁµêÊûúÁô∫Ë°®‰∏≠...";
                }
            });
        }

        function showScreen(id) {
            ['ctrl-login', 'ctrl-wait', 'ctrl-buttons'].forEach(i => document.getElementById(i).classList.add('hidden'));
            document.getElementById(id).classList.remove('hidden');
        }

        window.sendAns = (idx) => {
            if (navigator.vibrate) navigator.vibrate(50);
            enableButtons(false);
            update(ref(db, `rooms/${roomId}/players/${myId}`), { lastAns: idx });
        }

        function enableButtons(on) {
            const btns = document.querySelectorAll('.ctl-btn');
            btns.forEach(b => {
                b.disabled = !on;
                b.style.opacity = on ? 1 : 0.5;
                if(on) b.style.transform = "scale(1)";
            });
        }

    </script>
</body>
</html>
