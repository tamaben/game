<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <title>Joy-Con Werewolf: Chaos Edition</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --red: #ff4545; --blue: #00d2ff; --bg: #0a0a0c; }
        body { font-family: 'Helvetica Neue', Arial, sans-serif; background: var(--bg); color: white; margin: 0; overflow: hidden; }
        
        /* メインキャンバス */
        #game-board { position: relative; width: 100vw; height: 100vh; display: flex; align-items: center; justify-content: center; overflow: hidden; }
        
        /* プレイヤーサークル（中央配置） */
        .player-orbit { position: relative; width: 600px; height: 600px; border: 2px dashed rgba(255,255,255,0.1); border-radius: 50%; display: flex; align-items: center; justify-content: center; }
        .player-node { position: absolute; text-align: center; transition: all 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        .avatar { width: 80px; height: 80px; border-radius: 20px; border: 4px solid #444; margin-bottom: 10px; background: #222; position: relative; }
        .avatar.dead { filter: grayscale(1) brightness(0.5); border-color: #000 !important; }
        .avatar.dead::after { content: "DEAD"; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%) rotate(-20deg); color: red; font-weight: bold; border: 2px solid red; padding: 2px; }
        .shaking { animation: shake 0.1s infinite; }
        @keyframes shake { 0% { transform: translate(1px, 1px); } 50% { transform: translate(-1px, -1px); } 100% { transform: translate(1px, -1px); } }

        /* 投票の矢印線 */
        canvas#arrow-layer { position: absolute; top: 0; left: 0; pointer-events: none; }

        /* 右サイド：イベントログ */
        #event-log { position: absolute; right: 20px; top: 20px; width: 300px; height: 90vh; background: rgba(0,0,0,0.7); border-radius: 10px; padding: 15px; font-size: 0.9rem; overflow-y: auto; border-left: 2px solid var(--red); }
        .log-entry { margin-bottom: 10px; padding: 5px; border-bottom: 1px dotted #333; animation: slideIn 0.3s ease-out; }
        @keyframes slideIn { from { opacity: 0; transform: translateX(20px); } to { opacity: 1; transform: translateX(0); } }

        /* 中央のステータス */
        #center-ui { text-align: center; z-index: 10; }
        .phase-title { font-size: 3rem; font-weight: bold; text-transform: uppercase; letter-spacing: 5px; text-shadow: 0 0 20px var(--red); }
        
        /* ボタン類 */
        .controls { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); display: flex; gap: 20px; }
        .btn { background: var(--red); color: white; border: none; padding: 15px 40px; border-radius: 50px; font-size: 1.2rem; cursor: pointer; font-weight: bold; }
        .btn-sync { background: var(--blue); }

        #qr-overlay { position: absolute; top: 20px; left: 20px; background: white; padding: 10px; border-radius: 10px; }
    </style>
</head>
<body>

<div id="game-board">
    <canvas id="arrow-layer"></canvas>
    
    <div id="qr-overlay">
        <div id="qrcode"></div>
        <p style="color: black; margin: 5px 0 0; font-size: 12px; text-align: center; font-weight: bold;">ROOM: <span id="room-id">----</span></p>
    </div>

    <div class="player-orbit" id="player-orbit">
        <div id="center-ui">
            <div id="current-phase" class="phase-title">LOBBY</div>
            <div id="timer">00:00</div>
        </div>
        <!-- プレイヤーがここに追加される -->
    </div>

    <div id="event-log">
        <h3 style="color: var(--red);">EVENT LOG</h3>
        <div id="log-content"></div>
    </div>

    <div class="controls">
        <button class="btn btn-sync" onclick="connectHID()">JOY-CON同期</button>
        <button class="btn" onclick="advancePhase()">次のフェーズへ</button>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update, push } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDbZzTMvUkG2LXIGY4ux0KBTmnAdqP236s",
        authDomain: "game-4f2d9.firebaseapp.com",
        databaseURL: "https://game-4f2d9-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "game-4f2d9"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const roomId = Math.random().toString(36).substring(2, 6).toUpperCase();
    document.getElementById('room-id').innerText = roomId;

    let players = {};
    let currentPhase = 'lobby';
    let joycons = [];

    // QRコード生成
    const joinUrl = `${window.location.origin}${window.location.pathname}?r=${roomId}`;
    new QRCode(document.getElementById("qrcode"), { text: joinUrl, width: 100, height: 100 });

    // --- Joy-Con HID 制御 ---
    window.connectHID = async () => {
        const devices = await navigator.hid.requestDevice({
            filters: [{ vendorId: 0x057e, productId: 0x2006 }, { vendorId: 0x057e, productId: 0x2007 }]
        });
        for (const device of devices) {
            await device.open();
            // 振動コマンド送信（テスト）
            await device.sendReport(0x01, new Uint8Array([0x01, 0, 0, 0, 0, 0, 0, 0, 0, 0x40, 0x01])); 
            joycons.push(device);
            addLog(`Joy-Con (${device.productName}) が接続されました`);
        }
    };

    // --- フェーズ管理 ---
    window.advancePhase = async () => {
        const phases = ['lobby', 'night', 'day', 'voting', 'reveal', 'result'];
        let nextIndex = (phases.indexOf(currentPhase) + 1) % phases.length;
        currentPhase = phases[nextIndex];
        
        await update(ref(db, `rooms/${roomId}`), { phase: currentPhase });
        document.getElementById('current-phase').innerText = currentPhase.toUpperCase();
        
        if (currentPhase === 'reveal') {
            drawVoteArrows();
            processExecution();
        } else {
            clearArrows();
        }
        
        addLog(`フェーズが ${currentPhase} に切り替わりました`);
    };

    // --- プレイヤー描画 & 同期 ---
    onValue(ref(db, `rooms/${roomId}/players`), (snapshot) => {
        players = snapshot.val() || {};
        const orbit = document.getElementById('player-orbit');
        const nodes = orbit.querySelectorAll('.player-node');
        nodes.forEach(n => n.remove());

        const ids = Object.keys(players);
        ids.forEach((id, index) => {
            const p = players[id];
            const angle = (index / ids.length) * 2 * Math.PI;
            const x = Math.cos(angle) * 250;
            const y = Math.sin(angle) * 250;

            const node = document.createElement('div');
            node.className = 'player-node';
            node.id = `player-${id}`;
            node.style.left = `calc(50% + ${x}px - 40px)`;
            node.style.top = `calc(50% + ${y}px - 60px)`;
            
            node.innerHTML = `
                <div class="avatar ${p.alive === false ? 'dead' : ''}" style="border-color: ${p.color}"></div>
                <div class="player-name">${p.name}</div>
                <div style="font-size:10px; color:${p.color}">${p.role === '人狼' && currentPhase==='result' ? 'WOLF' : ''}</div>
            `;
            orbit.appendChild(node);
        });
    });

    // --- 投票の矢印描画（背信のマップ） ---
    function drawVoteArrows() {
        const canvas = document.getElementById('arrow-layer');
        canvas.width = window.innerWidth;
        canvas.height = window.innerHeight;
        const ctx = canvas.getContext('2d');
        
        Object.keys(players).forEach(id => {
            const p = players[id];
            if (p.votedFor && p.alive !== false) {
                const startEl = document.getElementById(`player-${id}`);
                const endEl = document.getElementById(`player-${p.votedFor}`);
                if (startEl && endEl) {
                    drawArrow(ctx, startEl, endEl, p.color);
                }
            }
        });
    }

    function drawArrow(ctx, startEl, endEl, color) {
        const start = startEl.getBoundingClientRect();
        const end = endEl.getBoundingClientRect();
        const sx = start.left + 40, sy = start.top + 40;
        const ex = end.left + 40, ey = end.top + 40;

        ctx.strokeStyle = color;
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(sx, sy);
        ctx.lineTo(ex, ey);
        ctx.stroke();

        // 矢印の先端
        const angle = Math.atan2(ey - sy, ex - sx);
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.moveTo(ex, ey);
        ctx.lineTo(ex - 15 * Math.cos(angle - Math.PI / 6), ey - 15 * Math.sin(angle - Math.PI / 6));
        ctx.lineTo(ex - 15 * Math.cos(angle + Math.PI / 6), ey - 15 * Math.sin(angle + Math.PI / 6));
        ctx.closePath();
        ctx.fill();
    }

    function clearArrows() {
        const canvas = document.getElementById('arrow-layer');
        const ctx = canvas.getContext('2d');
        ctx.clearRect(0, 0, canvas.width, canvas.height);
    }

    function processExecution() {
        // 最多得票者を計算
        const counts = {};
        Object.values(players).forEach(p => {
            if (p.votedFor) counts[p.votedFor] = (counts[p.votedFor] || 0) + 1;
        });
        
        let targetId = Object.keys(counts).reduce((a, b) => counts[a] > counts[b] ? a : b, null);
        if (targetId) {
            addLog(`【処刑】投票の結果、${players[targetId].name} が追放されました。`);
            update(ref(db, `rooms/${roomId}/players/${targetId}`), { alive: false });
            // ジョイコンに衝撃
            if (joycons[0]) { 
                // 本来はターゲットのジョイコンを特定して振動させる
            }
        }
    }

    function addLog(msg) {
        const logContent = document.getElementById('log-content');
        const entry = document.createElement('div');
        entry.className = 'log-entry';
        entry.innerText = `> ${msg}`;
        logContent.prepend(entry);
    }
</script>
</body>
</html>
