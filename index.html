<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Joy-Con Werewolf Ultimate</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        :root { --main-red: #e60012; --bg-dark: #121212; }
        body { font-family: 'Inter', sans-serif; background: var(--bg-dark); color: white; margin: 0; text-align: center; }
        .hidden { display: none !important; }
        
        /* ホスト画面 */
        #host-view { padding: 20px; }
        .qr-container { background: white; padding: 20px; display: inline-block; border-radius: 10px; margin: 20px; }
        .player-list { display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; }
        .player-card { width: 150px; padding: 15px; border-radius: 15px; border: 4px solid #444; transition: 0.3s; }
        .player-card.connected { border-color: var(--main-red); box-shadow: 0 0 15px var(--main-red); }

        /* スマホ画面 */
        #client-view { padding: 40px 20px; }
        input { padding: 15px; font-size: 1.2rem; border-radius: 8px; border: none; width: 80%; margin-bottom: 20px; }
        
        .btn { background: var(--main-red); color: white; border: none; padding: 15px 30px; font-size: 1.2rem; border-radius: 50px; cursor: pointer; font-weight: bold; }
        .btn:disabled { background: #555; }

        .role-reveal { font-size: 2.5rem; font-weight: bold; margin: 40px 0; color: #ff4500; text-shadow: 0 0 10px rgba(255,69,0,0.5); }
        
        /* ジョイコンビジュアル */
        .jc-icon { width: 40px; height: 100px; border-radius: 10px; margin: 0 auto 10px; position: relative; }
    </style>
</head>
<body>

<!-- メインコンテンツ -->
<div id="setup-view">
    <h1>JOY-CON人狼</h1>
    <button class="btn" onclick="initHost()">ホストとして部屋を作る</button>
    <p>またはスマホでQRをスキャンして参加</p>
</div>

<!-- ホスト画面: PCで見せる -->
<div id="host-view" class="hidden">
    <h2>ルームID: <span id="room-id-display"></span></h2>
    <div class="qr-container" id="qrcode"></div>
    <div id="host-msg">ジョイコンをPCにBluetooth接続し、下のボタンで同期してください</div>
    <br>
    <button class="btn" onclick="connectJoyCon()">ジョイコンを接続(HID)</button>
    <button class="btn" style="background: #2ecc71;" onclick="startGame()">ゲーム開始！</button>
    
    <div class="player-list" id="player-list"></div>
</div>

<!-- クライアント画面: スマホで操作 -->
<div id="client-view" class="hidden">
    <div id="client-join">
        <h2>参加者名を入力</h2>
        <input type="text" id="player-name" placeholder="なまえ">
        <button class="btn" onclick="joinGame()">参加する</button>
    </div>
    <div id="client-wait" class="hidden">
        <h2>待機中...</h2>
        <p>ホストが開始するのを待っています</p>
    </div>
    <div id="client-role" class="hidden">
        <p>あなたの役職は...</p>
        <div class="role-reveal" id="role-name">? ? ?</div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-app.js";
    import { getDatabase, ref, set, onValue, update } from "https://www.gstatic.com/firebasejs/12.9.0/firebase-database.js";

    const firebaseConfig = {
        apiKey: "AIzaSyDbZzTMvUkG2LXIGY4ux0KBTmnAdqP236s",
        authDomain: "game-4f2d9.firebaseapp.com",
        databaseURL: "https://game-4f2d9-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "game-4f2d9",
        storageBucket: "game-4f2d9.firebasestorage.app",
        messagingSenderId: "574316347824",
        appId: "1:574316347824:web:cf686040628e25ad615675"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    let roomId = "ROOM1234"; // 固定またはランダム生成
    let myPlayerId = null;

    // --- HID Joy-Con Logic ---
    let controllers = [];

    async function connectJoyCon() {
        try {
            const devices = await navigator.hid.requestDevice({
                filters: [{ vendorId: 0x057e, productId: 0x2006 }, { vendorId: 0x057e, productId: 0x2007 }]
            });
            
            for (const device of devices) {
                await device.open();
                // 簡易的な色取得（本来はSPIフラッシュ読み取りが必要ですが、ここでは接続確認を優先）
                // 実際には標準の0x10等のパケットで色を取得可能
                const jcData = {
                    id: device.productId === 0x2006 ? 'L' : 'R',
                    color: device.productId === 0x2006 ? '#00eeee' : '#ff4444', // デフォルト
                    deviceName: device.productName
                };
                
                // 振動テスト
                const rumble = new Uint8Array(9);
                rumble[0] = 0x10; // Rumble report
                await device.sendReport(0x01, rumble);

                alert(`${jcData.deviceName} が接続されました！`);
                
                // ジャイロの簡易検知（InputReport）
                device.oninputreport = (e) => {
                    const data = new Uint8Array(e.data.buffer);
                    // 簡易的な「振った」判定（加速度の変化）
                    if (data[13] > 200) { // しきい値
                        handleShake(jcData.id);
                    }
                };
            }
        } catch (e) {
            console.error("HID Error:", e);
        }
    }

    function handleShake(side) {
        console.log("Joy-Con Shaken:", side);
        // Firebaseにジャイロアクションを送信可能
    }

    // --- Game Logic ---
    window.initHost = () => {
        document.getElementById('setup-view').classList.add('hidden');
        document.getElementById('host-view').classList.remove('hidden');
        document.getElementById('room-id-display').innerText = roomId;
        
        const url = `${window.location.origin}${window.location.pathname}?room=${roomId}`;
        new QRCode(document.getElementById("qrcode"), { text: url, width: 128, height: 128 });

        // 参加者の監視
        onValue(ref(db, `games/${roomId}/players`), (snapshot) => {
            const players = snapshot.val();
            const listEl = document.getElementById('player-list');
            listEl.innerHTML = '';
            if (!players) return;

            Object.keys(players).forEach(id => {
                const p = players[id];
                const card = document.createElement('div');
                card.className = 'player-card connected';
                card.innerHTML = `
                    <div class="jc-icon" style="background: ${p.color || '#555'}"></div>
                    <div>${p.name}</div>
                `;
                listEl.appendChild(card);
            });
        });
    };

    window.joinGame = async () => {
        const name = document.getElementById('player-name').value;
        if (!name) return alert("名前を入力してください");
        
        myPlayerId = "player_" + Math.random().toString(36).substr(2, 9);
        await set(ref(db, `games/${roomId}/players/${myPlayerId}`), {
            name: name,
            role: "waiting",
            color: "#ffcc00"
        });

        document.getElementById('client-join').classList.add('hidden');
        document.getElementById('client-wait').classList.remove('hidden');

        // 役職配布の監視
        onValue(ref(db, `games/${roomId}/players/${myPlayerId}/role`), (snapshot) => {
            const role = snapshot.val();
            if (role !== "waiting") {
                document.getElementById('client-wait').classList.add('hidden');
                document.getElementById('client-role').classList.remove('hidden');
                document.getElementById('role-name').innerText = role;
            }
        });
    };

    window.startGame = async () => {
        const snapshot = await (ref(db, `games/${roomId}/players`));
        // 役職割り当てロジック
        update(ref(db, `games/${roomId}`), { status: "playing" });
        // ※実際にはここで全プレイヤーにランダムなroleをupdateする処理を追加
        alert("役職を配布しました。スマホを確認してください！");
    };

    // クライアント参加モード判定
    const params = new URLSearchParams(window.location.search);
    if (params.get('room')) {
        roomId = params.get('room');
        document.getElementById('setup-view').classList.add('hidden');
        document.getElementById('client-view').classList.remove('hidden');
    }

</script>
</body>
</html>
